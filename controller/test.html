<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Saisonknobeln</title>
        <style>
			body {
				overflow:hidden;
				padding:0;
				border:0;
				margin:0;
				background-color:green;
			}        
        
            #mati_canvas {
                position: absolute;
                left: 0;
                top: 0;
                width: 100vw;
                height: 100vh;
            }
            input#mati_spieler_text {
				position:absolute;
				display:block;
				line-height:1.4em;
				top:.4em;
				bottom:.4em;
				left:1em;
				width: 7.5em;
                padding: 0 .1em 0 1.2em;
				background-color: transparent;
				overflow:hidden;
                border: 0;
                margin: 0;
                font-size: 100%;
                font-family: Helvetica, Arial, sans-serif;
			}
        </style>
        <script src="matiWebglUtil.js"></script>
    </head>
    <body>
        <canvas id="mati_canvas" width="500" height="500"></canvas>
        <input id="mati_spieler_text" value="Player" />
        <canvas id="mati_canvas_2d" width="500" height="500"    style="display: none"     ></canvas>
        
        <img src="sound.svg" id="mati_musik_button"     style="display: none"      />
        <img src="sound-x.svg" id="mati_musik_button_x"     style="display: none"      />

        <script>
            var mati = {
                em : 45,
                gl : null,
                ctx2d : null,
                glRotation : 0.0,
                
                
				farbe : {r: 1, g: .5, b: 0},
				farbeHell50dunkel80 : {r: .8, g: .6, b: .4},
				farbeHell50 : {r: 1, g: .75, b: .5},
				farbeDunkel50 : {r: .5, g: .25, b: 0},
				farbeDunkel30 : {r: .3, g: .15, b: 0},
				spracheCode : null,
				sprachen : [],
				buttonMitFokus : null,
                
                themeAnzahlTexturspalten : 1,
                akutellesTheme : 0,
                altesTheme : 0,

                buttonEffektUniqueId : null,
                buttonEffektZoom : 1.5,
                
                mouseposInEmX : 0,
                mouseposInEmY : 0,

				anzahlSpieler : 0,
				schaetzungAntwortA : 8,
				schaetzungAntwortB : 2,
                schaetzungAntwortAFloat : 8,
				gewaehlteAnwortmoeglichkeit : 0,
				
				musikIstEingeschaltet : true,
                pauseMenueIstAufgeklappt : false,
                themeSelectionDeaktiviert : false,
                
                laufendeAnimationen : [],
                
                flags : ['bg', 'cn', 'cz', 'de', 'dk', 'ee', 'es', 'fi', 'fr', 'gb', 'gr', 'hr', 'hu', 'it', 'lt', 'lv', 'nl', 'no', 'pl', 'pt', 'ro', 'rs', 'ru', 'se', 'si', 'sk', 'tr', 'ua', 'us'],
                
                aktuelleRendergruppe : 'hauptmenue',
                vorherigeRendergruppe : null
                //aktuelleRendergruppe : 'schaetzung'
            };
        </script>
        
        <script src="mati.glProgramObjects.js"></script>
        
        <script>
            mati.renderObjektGruppen = {
                spieler : [
                    {
                        typ : 'spieler',
                        left : 0,
                        top : 0,
                        right : 0,
                        height: 4.4
                    }
                ],
                borderedBox : [ //TODO ggf doch besser in den einzelnen gruppen mit aufnehmen? kommt drauf an, ob ich die solid-color-faces sonst noch irgendwo nutze
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    }
                ],
                hauptmenue : [
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 3,
                        textLine : 0,
                        onClick : function() {
                            //TODO stattdessen mit server kommunizieren
                            mati.zeigeObjektGruppe('themeSelection');
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 9.9,
                        right : 1.5,
                        height : 3,
                        textLine : 1,
                        onClick : function() {
                            //TODO stattdessen mit server kommunizieren
                            mati.zeigeObjektGruppe('schaetzung');
                        }
                    },
                    {
                        typ : 'sprachAuswahl',
                        right : function() {
                            return mati.windowWidthInEm / 2 - 1;
                        },
                        bottom : 1.5,
                        width : 8,
                        height : 3,
                        textLine : 1,
                        onPointerDown : function() {
                            //TODO
                            console.log('sprachauswahl');
                        }
                    },
                    {
                        typ : 'soundButton',
                        left : function() {
                            return mati.windowWidthInEm / 2 + 2;
                        },
                        bottom : 1.5,
                        width : 5,
                        height : 3,
                        textLine : 1,
                        onPointerDown : function() {
                            //TODO
                            mati.musikIstEingeschaltet = !mati.musikIstEingeschaltet;
                        }
                    }
                ],
                bitteWarten : [
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 0
                    }
                ],
                antwortAuswahl : [
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 1
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 3,
                        textLine : 5
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 9.9,
                        right : 1.5,
                        height : 3,
                        textLine : 6
                    }
                ],
                themeSelection : [
                    {
                        typ : 'themeIcon',
                        width : 16,
                        top : 5.9,
                        right : function() {
                            return mati.windowWidthInEm / 2 - 8;
                        },
                        height : 8,
                        theme2 : false
                    },
                    {
                        typ : 'bigButton',
                        left : 5.5,
                        top : 14.9,
                        right : 5.5,
                        height : 3,
                        textLine : 4
                    },
                    {
                        typ : 'smallButton',
                        left : 1.5,
                        top : 14.9,
                        width : 3,
                        height : 3,
                        textLine : 9,
                        onPointerDown : function() {
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : 1.5,
                        top : 14.9,
                        width : 3,
                        height : 3,
                        textLine : 10,
                        onPointerDown : function() {
                        }
                    }
                ],
                
                
                
                
                schaetzung : [
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 2
                    },
                    {
                        typ : 'einzeiligerText',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 10.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 10.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 10.9;
                        },
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        height : 2,
                        textLine : 5
                    },
                    {
                        typ : 'schaetzungBalken',
                        left : 5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.9 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.9 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 13.4;
                        },
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + 4;
                            }
                            return 5;
                        },
                        height : 2,
                        zeigeWertB : 0
                    },
                    {
                        typ : 'smallButton',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 12.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 9,
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortA > 0) {
                                mati.schaetzungAntwortA -= 1;
                                mati.schaetzungAntwortB += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 12.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 10,
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortB > 0) {
                                mati.schaetzungAntwortB -= 1;
                                mati.schaetzungAntwortA += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'einzeiligerText',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 10.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 15.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 16.9;
                        },
                        right : 1.5,
                        height : 2,
                        textLine : 6,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        }
                    },
                    {
                        typ : 'schaetzungBalken',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + 4;
                            }
                            return 5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.9 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 18.4 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 19.4;
                        },
                        right : 5,
                        height : 2,
                        zeigeWertB : 1,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        }
                    },
                    {
                        typ : 'smallButton',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 17.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 18.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 9,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        },
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortB > 0) {
                                mati.schaetzungAntwortB -= 1;
                                mati.schaetzungAntwortA += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 17.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 18.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 10,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        },
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortA > 0) {
                                mati.schaetzungAntwortA -= 1;
                                mati.schaetzungAntwortB += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 28.4) {
                                return null;
                            }
                            return 23.9;
                        },
                        bottom : function() {
                            if (mati.windowHeightInEm < 28.4) {
                                return 1.5;
                            }
                            return null;
                        },
                        right : 1.5,
                        height : 3,
                        textLine : 4
                        
                    }
                ]
            };
            
            mati.readValueFromFunctionOrPrimitive = function(elementObject, attributeName) {
                if (typeof elementObject[attributeName] === 'number'
                        || typeof elementObject[attributeName] === 'boolean') {
                    return elementObject[attributeName];
                }
                if (typeof elementObject[attributeName] === 'function') {
                    return elementObject[attributeName]();
                }
                return null;
            };
            
            mati.getRenderObjektKoordinatenInEm = function(elementObject) {
                let attributeLeft = mati.readValueFromFunctionOrPrimitive(elementObject, 'left');
                let attributeTop = mati.readValueFromFunctionOrPrimitive(elementObject, 'top');
                let attributeRight = mati.readValueFromFunctionOrPrimitive(elementObject, 'right');
                let attributeBottom = mati.readValueFromFunctionOrPrimitive(elementObject, 'bottom');
                let attributeWidth = mati.readValueFromFunctionOrPrimitive(elementObject, 'width');
                let attributeHeight = mati.readValueFromFunctionOrPrimitive(elementObject, 'height');
            
                let x = attributeLeft !== null ? attributeLeft : mati.windowWidthInEm - attributeRight - attributeWidth;
                let y = attributeTop !== null ? attributeTop : mati.windowHeightInEm - attributeBottom - attributeHeight;
                let width = attributeWidth !== null ? attributeWidth : mati.windowWidthInEm - attributeRight - attributeLeft;
                let height = attributeHeight !== null ? attributeHeight : mati.windowHeightInEm - attributeBottom - attributeTop;
                return {x:x, y:y, width:width, height:height};
            };
            
            mati.animateSchaetzung = function() {
                mati.cancelLaufendeAnimation('schaetzungAntwortAFloat');
                let highResTimeStamp = window.performance.now();
                mati.laufendeAnimationen.push({
                    matiAttribute : 'schaetzungAntwortAFloat',
                    startValue : mati.schaetzungAntwortAFloat,
                    endValue : mati.schaetzungAntwortA,
                    startTime : highResTimeStamp,
                    endTime : highResTimeStamp + 250
                });
            };
            
            mati.getLaufendeAnimationByMatiAttribute = function(matiAttribute) {
                for (let laufendeAnimation of mati.laufendeAnimationen) {
                    if (laufendeAnimation.matiAttribute === matiAttribute) {
                        return laufendeAnimation;
                    }
                }
                return null;
            };
            
            mati.getIndexOfLaufendeAnimationByMatiAttribute = function(matiAttribute) {
                for (let index = 0; index < mati.laufendeAnimationen.length; index++) {
                    if (mati.laufendeAnimationen[index].matiAttribute === matiAttribute) {
                        return index;
                    }
                }
                return -1;
            };
            
            mati.cancelLaufendeAnimation = function(matiAttribute) {
                let index = mati.getIndexOfLaufendeAnimationByMatiAttribute(matiAttribute);
                if (index >= 0) {
                    mati.laufendeAnimationen.splice(index, 1);
                }
            };
            
            mati.zeigeObjektGruppe = function(key) {
                let bereitsLaufendeAnimation = mati.getLaufendeAnimationByMatiAttribute('glRotation');
                if (bereitsLaufendeAnimation !== null) {
                    return;
                }
                
                //TODO alle sonstigen laufenden Animationen beenden, die von der Würfelanimation beeinträchtigt würden
            
                mati.vorherigeRendergruppe = mati.aktuelleRendergruppe;
                mati.aktuelleRendergruppe = key;
                mati.glRotation = -Math.PI/2;
                
                let highResTimeStamp = window.performance.now();
                
                mati.laufendeAnimationen.push({
                    matiAttribute : 'glRotation',
                    startValue : -Math.PI/2,
                    endValue : 0,
                    startTime : highResTimeStamp,
                    endTime : highResTimeStamp + 1000
                });
            };
            
            
            
            mati.isButtonUnterAktuellerMousePosition = function(elementObject) {
                let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
            
                if (mati.mouseposInEmY >= buttonKoordinaten.y
                        && mati.mouseposInEmY <= buttonKoordinaten.y + 3) {
                    if (mati.mouseposInEmX >= buttonKoordinaten.x + 1.5
                            && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width - 1.5) {
                        return true;
                    }
                    if (mati.mouseposInEmX >= buttonKoordinaten.x
                            && mati.mouseposInEmX <= buttonKoordinaten.x + 1.5) {
                        let deltaX = buttonKoordinaten.x + 1.5 - mati.mouseposInEmX;
                        let deltaY = buttonKoordinaten.y + 1.5 - mati.mouseposInEmY;
                        let deltaXNorm = deltaX / 1.5;
                        let deltaYNorm = deltaY / 1.5;
                        return deltaXNorm * deltaXNorm + deltaYNorm * deltaYNorm <= 1;
                    }
                    if (mati.mouseposInEmX >= buttonKoordinaten.x + buttonKoordinaten.width - 1.5
                            && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                        let deltaX = buttonKoordinaten.x + buttonKoordinaten.width - 1.5 - mati.mouseposInEmX;
                        let deltaY = buttonKoordinaten.y + 1.5 - mati.mouseposInEmY;
                        let deltaXNorm = deltaX / 1.5;
                        let deltaYNorm = deltaY / 1.5;
                        return deltaXNorm * deltaXNorm + deltaYNorm * deltaYNorm <= 1;
                    }
                }
                return false;
            };
            
            mati.getTouchedButtonObject = function() {
                //TODO es duerfen keine Wuerfelanimationen laufen

                for (let elementObject of mati.renderObjektGruppen[mati.aktuelleRendergruppe]) {
                    if (elementObject.typ === 'bigButton'
                            || elementObject.typ === 'smallButton'
                            || elementObject.typ === 'sprachAuswahl') {
                        if (mati.isButtonUnterAktuellerMousePosition(elementObject)) {
                            return elementObject;
                        }
                    }
                    if (elementObject.typ === 'soundButton') {
                        let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
                        if (mati.mouseposInEmY >= buttonKoordinaten.y
                                && mati.mouseposInEmY <= buttonKoordinaten.y + buttonKoordinaten.height
                                && mati.mouseposInEmX >= buttonKoordinaten.x
                                && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                            return elementObject;
                        }
                    }
                }

                return null;
            };
            
            

            
            //Wird von Pointer-, Maus- und Touch-Events genutzt (iOS kann keine Pointer-Events). Daher muss sichergestellt werden, dass die Aktion nur einmal ausgefuehrt wird.
            mati.onPointerDown = function(event, target, mouseposInEmX, mouseposInEmY) {
                if (document.getElementById('mati_spieler_text') === document.activeElement) {
                    //Nichts ausfuehren und keine preventDefault, damit man sicher per Touch den Fokus entfernen kann
                    //TODO ggf doch was tun bei multitouch?
                    return;
                }
            
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();
				
                if (touchedButton !== null) {
                    event.preventDefault();
                }
                
				if (touchedButton !== null && mati.buttonMitFokus === null) {
					mati.buttonMitFokus = touchedButton;
					
					//Kleine Buttons schon bei touchstart ausloesen
					if (touchedButton.onPointerDown) {
                        touchedButton.onPointerDown();
                        
                        /*
						switch (closestButton.id) {
							case 'mati_schieberegler_minus_a':
							case 'mati_schieberegler_plus_b':
								if (mati.schaetzungAntwortA > 0) {
									mati.schaetzungAntwortA--;
									mati.schaetzungAntwortB = mati.anzahlSpieler - mati.schaetzungAntwortA;
									mati.updateSchaetzungGui();
								}
								break;
							case 'mati_schieberegler_minus_b':
							case 'mati_schieberegler_plus_a':
								if (mati.schaetzungAntwortB > 0) {
									mati.schaetzungAntwortB--;
									mati.schaetzungAntwortA = mati.anzahlSpieler - mati.schaetzungAntwortB;
									mati.updateSchaetzungGui();
								}
								break;
                            case 'mati_spieler_menuebutton':
                                if (mati.pauseMenueIstAufgeklappt) {
                                    mati.pauseMenueAusblenden();
                                }
                                else {
                                    document.getElementById('mati_pause_menue').classList.add('mati_pause_menue_visible');
                                    document.getElementById('mati_spieler_menuebutton').classList.add('mati_spieler_menuebutton_aufgeklappt');
                                    mati.pauseMenueIstAufgeklappt = true;
                                }
                                break;
                            case 'mati_theme_selection_button_prev':
                                if (!mati.themeSelectionDeaktiviert) {
                                    mati.themeSelectionDeaktiviert = true;
                                    Tiltspot.send.msg('prevTheme');
                                }
                                break;
                            case 'mati_theme_selection_button_next':
                                if (!mati.themeSelectionDeaktiviert) {
                                    mati.themeSelectionDeaktiviert = true;
                                    Tiltspot.send.msg('nextTheme');
                                }
                                break;
                            case 'mati_theme_selection_items':
                                if (!mati.themeSelectionDeaktiviert) {
                                    Tiltspot.send.msg('themeSelectionOk');
                                }
                                break;
						}
                        */
					}
				}
            };
            
            mati.onPointerUp = function (event, target, mouseposInEmX, mouseposInEmY) {
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();
                
				if (touchedButton !== null) {
                    event.preventDefault();
                }
            
				if (touchedButton !== null && mati.buttonMitFokus === touchedButton && touchedButton.onClick) {
					if (touchedButton.typ === 'bigButton') {
						//Button-Effekt
                        
                        //falls noch eine alte animation laeuft, muss die gefinished werden
                        mati.cancelLaufendeAnimation('buttonEffektZoom');
                        
                        mati.buttonEffektUniqueId = touchedButton.uniqueId;

                        mati.buttonEffektZoom = 1;
                        let highResTimeStamp = window.performance.now();
                        mati.laufendeAnimationen.push({
                            matiAttribute : 'buttonEffektZoom',
                            startValue : 1,
                            endValue : 2,
                            startTime : highResTimeStamp,
                            endTime : highResTimeStamp + 1000,
                            onFinish : function() {
                                mati.buttonEffektUniqueId = null;
                            }
                        });
                        
                        //TODO
						/*let cloneButton = document.createElement("div");
						cloneButton.classList.add('mati_button');
						cloneButton.innerText = closestButton.innerText;
						let cloneContainer = document.createElement("div");
						cloneContainer.classList.add('mati_buttoneffekt_container');
						cloneContainer.style['top'] = boundingClientRect.top + 'px';
						cloneContainer.appendChild(cloneButton);
						document.getElementById('mati_controller_alles').appendChild(cloneContainer);
						setTimeout(function () {
							document.getElementById('mati_controller_alles').removeChild(cloneContainer);
						}, 1000);
						*/
                    }
                    touchedButton.onClick();
						/*//Aktion ausfuehren
						switch (closestButton.id) {
							case 'mati_button_neues_spiel':
								Tiltspot.send.msg('neuesSpiel');
								break;
							case 'mati_antwortmoeglichkeit_a':
								mati.gewaehlteAnwortmoeglichkeit = 0;
								mati.schaetzungAntwortA = mati.gewaehlteAnwortmoeglichkeit === 0 ? Math.ceil(mati.anzahlSpieler / 2) : Math.floor(mati.anzahlSpieler / 2);
								mati.schaetzungAntwortB = mati.anzahlSpieler - mati.schaetzungAntwortA;
								mati.updateSchaetzungGui();
								matiUtil.pushBefehl(function() {
									mati.zeigeContainer(document.getElementById('mati_schaetzung'), function() {
										document.getElementById('mati_schieberegler_anzeige_balken_a').classList.add('mati_schieberegler_anzeige_balken_transition');
										document.getElementById('mati_schieberegler_anzeige_balken_b').classList.add('mati_schieberegler_anzeige_balken_transition');
										matiUtil.gotoNaechsterBefehl();
									});
								});
								break;
							case 'mati_antwortmoeglichkeit_b':
								mati.gewaehlteAnwortmoeglichkeit = 1;
								mati.schaetzungAntwortA = mati.gewaehlteAnwortmoeglichkeit === 0 ? Math.ceil(mati.anzahlSpieler / 2) : Math.floor(mati.anzahlSpieler / 2);
								mati.schaetzungAntwortB = mati.anzahlSpieler - mati.schaetzungAntwortA;
								mati.updateSchaetzungGui();
								matiUtil.pushBefehl(function() {
									mati.zeigeContainer(document.getElementById('mati_schaetzung'), function() {
										document.getElementById('mati_schieberegler_anzeige_balken_a').classList.add('mati_schieberegler_anzeige_balken_transition');
										document.getElementById('mati_schieberegler_anzeige_balken_b').classList.add('mati_schieberegler_anzeige_balken_transition');
										matiUtil.gotoNaechsterBefehl();
									});
								});
								break;
							case 'mati_button_schaetzung_submit':
								Tiltspot.send.msg('antwortAbgeben', {
									antwort: mati.gewaehlteAnwortmoeglichkeit,
									schaetzungAntwortA : mati.schaetzungAntwortA,
									schaetzungAntwortB : mati.schaetzungAntwortB
								});
								document.getElementById('mati_schieberegler_anzeige_balken_a').classList.remove('mati_schieberegler_anzeige_balken_transition');
								document.getElementById('mati_schieberegler_anzeige_balken_b').classList.remove('mati_schieberegler_anzeige_balken_transition');
								matiUtil.pushBefehl(function() {
									mati.zeigeContainer(document.getElementById('mati_wartebild'), matiUtil.gotoNaechsterBefehl);
								});
								break;
							case 'mati_button_spiel_abschliessen':
								Tiltspot.send.msg('spielAbschliessen');
								break;
							case 'mati_button_beenden':
								Tiltspot.exitGame();
								break;
                            case 'mati_button_spiel_fortsetzen':
                                mati.pauseMenueAusblenden();
                                break;
                            case 'mati_button_spiel_abbrechen':
                                mati.pauseMenueAusblenden();
                                Tiltspot.send.msg('spielAbbrechen');
                                break;
                            case 'mati_theme_selection_button_ok':
                                Tiltspot.send.msg('themeSelectionOk');
                                break;
						}*/
				}

                //Im Zweifel einfach auf alle Up-Events reagieren, selbst wenn target nicht stimmt
                mati.buttonMitFokus = null;
			};
            
            mati.onPointerMove = function (event, target, mouseposInEmX, mouseposInEmY) {
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();

				if (touchedButton !== null) {
                    event.preventDefault();
                }

				if (touchedButton !== mati.buttonMitFokus) {
					mati.buttonMitFokus = null;
				}
			};
            
            mati.onPointerCancel = function (event, target, mouseposInEmX, mouseposInEmY) {
                mati.buttonMitFokus = null;
            };
            
            
            
            
            
            
            
            //FIXME das hier muss mit einsatzverzoegerung sein (debounce)
            mati.onWindowResize = function() {
                var width = window.innerWidth * window.devicePixelRatio;
                var height = window.innerHeight * window.devicePixelRatio;
                
                let em1 = width / 20;
                let em2 = height / 20.9;
                mati.em = Math.min(em1, em2);
                
                document.getElementById('mati_spieler_text').style['font-size'] = (mati.em * 2) + 'px';
                
                mati.windowWidthInEm = width / mati.em;
                mati.windowHeightInEm = height / mati.em;
                
                mati.gl.canvas.width = width;
                mati.gl.canvas.height = height;
                mati.gl.viewport(0, 0, mati.gl.drawingBufferWidth, mati.gl.drawingBufferHeight);
                
                for (let programObjectKey in mati.glProgramObjects) {
                    programObject = mati.glProgramObjects[programObjectKey];
                    mati.gl.useProgram(programObject.program);
                    
                    let verticesArray = [];
                    let indicesArray = [];
                    let vertexStartIndexUndAnzahlProElementGruppe = {};
                    let vertexStartIndexUndAnzahlProElement = {};
                    for (let renderObjektGruppeKey in mati.renderObjektGruppen) {
                        vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey] = {
                            startIndex : indicesArray.length,
                            nPoints : 0
                        };
                        let renderObjektGruppe = mati.renderObjektGruppen[renderObjektGruppeKey];
                        for (let elementObject of renderObjektGruppe) {
                            vertexStartIndexUndAnzahlProElement[elementObject.uniqueId] = {
                                startIndex : indicesArray.length,
                                nPoints : 0
                            };
                            if (!mati.readValueFromFunctionOrPrimitive(elementObject, 'ausblenden')) {
                                programObject.befuelleVertexArray(elementObject, verticesArray, indicesArray);
                                vertexStartIndexUndAnzahlProElement[elementObject.uniqueId].nPoints = indicesArray.length - vertexStartIndexUndAnzahlProElement[elementObject.uniqueId].startIndex;
                            }
                        }
                        vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey].nPoints = indicesArray.length - vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey].startIndex;
                    }
                    matiWebglUtil.befuelleAttributeBuffer(mati.gl, verticesArray, indicesArray, programObject.vertexBuffer, programObject.indexBuffer);
                    
                    programObject.verticesArray = verticesArray;
                    programObject.vertexStartIndexUndAnzahlProElementGruppe = vertexStartIndexUndAnzahlProElementGruppe;
                    programObject.vertexStartIndexUndAnzahlProElement = vertexStartIndexUndAnzahlProElement;
                }
            };
            
            mati.executeProgram = function(programObject, vertexStartIndexUndAnzahl, rotation) {
                mati.gl.useProgram(programObject.program);
                mati.gl.bindBuffer(mati.gl.ARRAY_BUFFER, programObject.vertexBuffer);
                mati.gl.bindBuffer(mati.gl.ELEMENT_ARRAY_BUFFER, programObject.indexBuffer);
                matiWebglUtil.setAttributePointerAndEnableAttributeArray(mati.gl, programObject.program, programObject.verticesArray);
                programObject.setUniforms(rotation);
                mati.gl.drawElements(mati.gl.TRIANGLES, vertexStartIndexUndAnzahl.nPoints, mati.gl.UNSIGNED_SHORT, vertexStartIndexUndAnzahl.startIndex * 2);
                matiWebglUtil.disableAttributeArray(mati.gl, programObject.program, programObject.verticesArray);
            };
            
            mati.repaint = function(now) {
                for (let i = mati.laufendeAnimationen.length - 1; i >= 0; i--) {
                    let animation = mati.laufendeAnimationen[i];
                    if (animation.startTime <= now) {
                        if (animation.endTime <= now) {
                            mati[animation.matiAttribute] = animation.endValue;
                            mati.laufendeAnimationen.splice(i, 1);
                            if (animation.onFinish) {
                                animation.onFinish();
                            }
                        }
                        else {
                            let vergangen = now - animation.startTime;
                            let gesamt = animation.endTime - animation.startTime;
                            let vergangenerBruchteil = vergangen / gesamt;
                            mati[animation.matiAttribute] = animation.startValue * (1-vergangenerBruchteil) + animation.endValue * vergangenerBruchteil;
                        }
                    }
                }
                
                mati.gl.clear(mati.gl.COLOR_BUFFER_BIT);
                
                mati.paintRendergruppe('spieler', 0);
                mati.paintRendergruppe('borderedBox', mati.glRotation);
                mati.paintRendergruppe(mati.aktuelleRendergruppe, mati.glRotation);
                if (mati.glRotation !== 0) {
                    let rotationAlteBox = mati.glRotation + Math.PI/2;
                    mati.paintRendergruppe('borderedBox', rotationAlteBox);
                    mati.paintRendergruppe(mati.vorherigeRendergruppe, rotationAlteBox);
                }

                if (mati.buttonEffektUniqueId !== null) {
                    let programObject = mati.glProgramObjects.buttonEffekt;
                    let vertexStartIndexUndAnzahl = programObject.vertexStartIndexUndAnzahlProElement[mati.buttonEffektUniqueId];
                    mati.executeProgram(programObject, vertexStartIndexUndAnzahl, 0);
                }
                
                window.requestAnimationFrame(mati.repaint);
            };
            
            mati.paintRendergruppe = function(rendergruppeKey, rotation) {
                for (let programObjectKey in mati.glProgramObjects) {
                    if (programObjectKey !== 'buttonEffekt') {
                        let programObject = mati.glProgramObjects[programObjectKey];
                        let vertexStartIndexUndAnzahl = programObject.vertexStartIndexUndAnzahlProElementGruppe[rendergruppeKey];
                        if (vertexStartIndexUndAnzahl.nPoints > 0) {
                            mati.executeProgram(programObject, vertexStartIndexUndAnzahl, rotation);
                        }
                    }
                }
            };
            
            mati.canvas2dCreateLineBreakt = function(ctx, words, maxWidthInPx, maxNumberOfLines) {
                let lines = [];
                let textPasst = true;
                let wordIndex = 0;
                while (wordIndex < words.length) {
                    if (lines.length === maxNumberOfLines) {
                        //Es ist noch text uebrig, aber die maximale Zeilenzahl ist bereits erreicht
                        return null;
                    }
                    let line = words[wordIndex++];
                    if (ctx.measureText(line).width > maxWidthInPx) {
                        //das einzelne Wort ist bereits zu lang
                        return null;
                    }
                    while (wordIndex < words.length) {
                        let lineMitEinemWortMehr = line + ' ' + words[wordIndex];
                        if (ctx.measureText(lineMitEinemWortMehr).width > maxWidthInPx) {
                            break;
                        }
                        line = lineMitEinemWortMehr;
                        wordIndex++;
                    }
                    lines.push(line);
                }
                return lines;
            };
            
            mati.canvas2dRenderText = function(ctx, text, x, y, maxWidthInPx, maxHeightInPx, font, fontSizeInPx, lineHeightInPx, bold = false) {
                let words = text.split(' ');
                let lines;
                let angepassteLineHeightInPx;
                let angepassteFontSizeInPx = fontSizeInPx;
                for (let i=0; i<20; i++) {
                    ctx.font = (bold ? 'bold ' : '') + angepassteFontSizeInPx + "px " + font;
                    angepassteLineHeightInPx = Math.ceil(lineHeightInPx * angepassteFontSizeInPx / fontSizeInPx);
                    
                    let maxNumberOfLines = Math.floor(maxHeightInPx / angepassteLineHeightInPx);
                    lines = mati.canvas2dCreateLineBreakt(ctx, words, maxWidthInPx, maxNumberOfLines);
                    if (lines !== null) {
                        break;
                    }

                    angepassteFontSizeInPx *= .9;
                }
                
                if (lines !== null) {
                    for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                        let yOffset = (lineIndex - (lines.length-1)/2) * angepassteLineHeightInPx;
                        ctx.fillText(lines[lineIndex], x, y + yOffset);
                    }
                }
            };
            
            window.addEventListener('load', function() {
                document.getElementById('mati_spieler_text').style['color'] = 'rgb(' + Math.round(mati.farbeHell50.r * 255) + ', ' + Math.round(mati.farbeHell50.g * 255) + ', ' + Math.round(mati.farbeHell50.b * 255) + ')';
                
                
                
                
                let uniqueId = 1;
                for (let gruppenKey in mati.renderObjektGruppen) {
                    let gruppe = mati.renderObjektGruppen[gruppenKey];
                    for (let elementObjekt of gruppe) {
                        elementObjekt.uniqueId = uniqueId++;
                    }
                }
            
            
            
                var canvas = document.getElementById("mati_canvas");
                mati.gl = canvas.getContext("webgl");
                mati.gl.enable(mati.gl.BLEND);
                mati.gl.blendFunc(mati.gl.ONE, mati.gl.ONE_MINUS_SRC_ALPHA);

                mati.gl.enable(mati.gl.CULL_FACE);
                mati.gl.cullFace(mati.gl.BACK);

                mati.gl.clearColor(mati.farbeDunkel30.r, mati.farbeDunkel30.g, mati.farbeDunkel30.b, 1);
                
                
                
                
                for (let programObjectKey in mati.glProgramObjects) {
                    let programObject = mati.glProgramObjects[programObjectKey];
                    
                    let vertexShader = matiWebglUtil.createVertexShader(mati.gl, programObject.vertexShader);
                    let fragmentShader = matiWebglUtil.createFragmentShader(mati.gl, programObject.fragmentShader);
                    programObject.program = matiWebglUtil.createProgram(mati.gl, vertexShader, fragmentShader);
                    programObject.vertexBuffer = mati.gl.createBuffer();
                    programObject.indexBuffer = mati.gl.createBuffer();
                    for (let uniformName of programObject.uniformNames) {
                        programObject[uniformName] = mati.gl.getUniformLocation(programObject.program, uniformName)
                    }
                }

                
                var canvas2d = document.getElementById("mati_canvas_2d");
                canvas2d.width = 2048;
                canvas2d.height = 2048;
                mati.ctx2d = canvas2d.getContext('2d');
                
                
                
                
                
                
                
                
                
                
                var texture = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE0);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture);
                
                let emGerundet = 2048 / 32;
                
                const font = 'Arial';
                const fontSize = emGerundet;
                const lineHeight = emGerundet * 1.3;
                
                mati.ctx2d.fillStyle = "white";
                mati.ctx2d.textAlign = "center";
                mati.ctx2d.textBaseline = "middle";
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Neues Spiel',
                        emGerundet * 8, emGerundet, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Beenden',
                        emGerundet * 8, emGerundet * 3, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Laufendes Spiel abbrechen',
                        emGerundet * 8, emGerundet * 5, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Zurück zum Spiel',
                        emGerundet * 8, emGerundet * 7, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'OK',
                        emGerundet * 8, emGerundet * 9, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, '[Antwort-Möglichkeit 1]',
                        emGerundet * 8, emGerundet * 11, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, '[Antwort-Möglichkeit 2]',
                        emGerundet * 8, emGerundet * 13, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                //Pfeil links
                //Pfeil rechts
                //Minus
                mati.ctx2d.fillRect(emGerundet*7.25, emGerundet*18.875, emGerundet*1.5, emGerundet*0.25);
                //Plus
                mati.ctx2d.fillRect(emGerundet*7.25, emGerundet*20.875, emGerundet*1.5, emGerundet*0.25);
                mati.ctx2d.fillRect(emGerundet*7.875, emGerundet*20.25, emGerundet*0.25, emGerundet*1.5);
                //Ziffern
                for (let i=0; i<79; i++) {
                    let reihe = Math.floor(i / 8);
                    let spalte = i % 8;
                    mati.canvas2dRenderText(mati.ctx2d, i + '', emGerundet * (17 + spalte*2), emGerundet * (1 + reihe*2), emGerundet * 2, emGerundet * 2, 'Arial', emGerundet, emGerundet * 1.4, true);
                }
                
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Bitte warten bis die nächste Interaktion möglich ist!',
                        23.5*emGerundet, 22*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Wähle eine Antwort! Halte Deine Wahl vor den anderen Spielern geheim!',
                        23.5*emGerundet, 26*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'Schätze wie viele Spieler (inklusive Du selbst) für die jeweilige Antwortmöglichkeit gestimmt haben!',
                        23.5*emGerundet, 30*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);

                
                mati.ctx2d.drawImage(document.getElementById('mati_musik_button'), 0, 15*emGerundet, 5*emGerundet, 3*emGerundet);
                mati.ctx2d.drawImage(document.getElementById('mati_musik_button_x'), 0, 19*emGerundet, 5*emGerundet, 3*emGerundet);

                mati.gl.activeTexture(mati.gl.TEXTURE0);
                mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.ALPHA, mati.gl.ALPHA, mati.gl.UNSIGNED_BYTE, canvas2d);
                mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
                //mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MAG_FILTER, mati.gl.NEAREST);
                //mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.NEAREST_MIPMAP_LINEAR);
                
                
                
                
                
                
                var texture2 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE1);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture2);
                
                mati.ctx2d.clearRect(0, 0, 2048, 2048);
                let zuLadendeBilder = mati.flags.length;
                for (let flagCode of mati.flags) {
                    let img = document.createElement('img');
                    img.addEventListener("load", function() {
                        let index = mati.flags.indexOf(flagCode);
                        let spalte = index % 6;
                        let zeile = Math.floor(index / 6);
                        
                        let seitenverhaeltnis = img.naturalWidth / img.naturalHeight;
                        let offsetX = 0;
                        let offsetY = 0;
                        if (img.naturalWidth > img.naturalHeight * 2) {
                            offsetY = (img.naturalWidth/2 - img.naturalHeight) / img.naturalWidth * 128;
                        }
                        if (img.naturalWidth < img.naturalHeight * 2) {
                            offsetX = (img.naturalHeight*2 - img.naturalWidth) / img.naturalHeight * 64;
                        }
                        
                        mati.ctx2d.drawImage(img, spalte * 320 + 32 + offsetX, zeile * 192 + 32 + offsetY, 256 - 2 * offsetX, 128 - 2 * offsetY);
                        
                        zuLadendeBilder--;
                        if (zuLadendeBilder === 0) {
                            console.log('alles geladen!');
                            mati.gl.activeTexture(mati.gl.TEXTURE1);
                            mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.RGBA, mati.gl.RGBA, mati.gl.UNSIGNED_BYTE, canvas2d);
                            mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                            mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
                        }
                    });
                    // TODO asset-url
                    img.src = '../assets/flags/' + flagCode + '.svg'
                }
                
                //mati.ctx2d.drawImage(document.getElementById('mati_flagge_de'), 0, 0, 1200, 600);
                
                
                
                
                
                
                var texture3 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE2);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture3);
                //TODO avatar in textur rendern
                
                
                
                
                
                
                var texture4 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE3);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture4);
                //TODO themes in textur rendern
                
                
                
                
                
                
                mati.onWindowResize();
                window.addEventListener('resize', mati.onWindowResize);
                
                
                
                document.addEventListener('touchstart', function(event) {
                    //target steht zwar auch direkt im event, allerdings keine Koordinaten
                    mati.onPointerDown(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointerdown', function(event) {
                    //FIXME nur auf pen hoeren (oder anders als 'mouse'/'touch')! ... teste ob beim pen ggf. auch immer einer der anderen events feuert
                    if (event.pointerType !== "mouse" || event.button === 0) {
                        mati.onPointerDown(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });
                document.addEventListener('mousedown', function(event) {
                    if (event.button === 0) { //linker Maus-Button
                        mati.onPointerDown(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });
                
                document.addEventListener('touchend', function (event) {
                    mati.onPointerUp(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointerup', function (event) {
                    //FIXME nur auf pen hoeren!
                    mati.onPointerUp(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                document.addEventListener('mouseup', function (event) {
                    if (event.button === 0) { //linker Maus-Button
                        mati.onPointerUp(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });            

                document.addEventListener('touchmove', function (event) {
                    mati.onPointerMove(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointermove', function (event) {
                    //FIXME nur auf pen hoeren!
                    mati.onPointerMove(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                document.addEventListener('mousemove', function (event) {
                    mati.onPointerMove(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                
                document.addEventListener('touchcancel', function (event) {
                    mati.onPointerCancel(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointercancel', function (event) {
                    mati.onPointerCancel(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });
                
                
                
                window.requestAnimationFrame(mati.repaint);
            });
        </script>
    </body>
</head>