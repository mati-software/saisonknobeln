<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Saisonknobeln</title>
		<style>
			body {
				overflow:hidden;
				padding:0;
				border:0;
				margin:0;
				background-color:black;
			}
		
			#mati_controller_alles {
				position:fixed;
				top:0;
				left:0;
				right:0;
				bottom:0;
				color:white;
				font-family: Helvetica, Arial, sans-serif;
				
				-webkit-user-select: none;  
				-moz-user-select: none;    
				-ms-user-select: none;      
				user-select: none;
			}
			
			#mati_content_container {
				position:absolute;
				left:0;
				right:0;
				bottom:0;
				top:4.4em;
				box-shadow:0 0 .4em black;
				z-index:2;
			}
			
			.mati_buttonbox {
				position:absolute;
				left:0;
				right:0;
				bottom:0;
				top:0;
				border-width:.5em;
				border-style:solid;
				box-shadow: inset 0 0 1em black;
				
				display: none;
				
				backface-visibility: hidden;
			}
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			.mati_button {
				color: black;
				padding:.5em;
				text-align:center;
				line-height:2em;
				border-radius:1.5em;
				vertical-align:middle;
			}
			.mati_buttonbox .mati_button {
				box-shadow:0 0 1em black;
				margin:1em;
			}
			
			@keyframes mati_animation_buttoneffekt {
				from {
					transform: scale(1);
					opacity:1;
				}
				to {
					transform: scale(4);
					opacity:0;
				}
			}
			.mati_buttoneffekt_container {
				position:absolute;
				left:1.5em;
				right:1.5em;
				animation-name: mati_animation_buttoneffekt;
				animation-duration: 1s;
				animation-timing-function: linear;
				z-index:3;
			}
			
			.mati_spieler {
				padding:0;
				margin:0;
				height:2.2em;
				vertical-align:middle;
				overflow:hidden;
				position:relative;
				width:10em;
				z-index:1;
			}
			span.mati_spieler_img {
				position:absolute;
				left:.2em;
				top:.2em;
				border-radius:.9em;
				padding:.1em;
				width:1.6em;
				height:1.6em;
				overflow:hidden;
				z-index:2;
				box-shadow:0 0 .2em black;
			}
			span.mati_spieler_img img {
				float:left;
				width:1.6em;
				height:1.6em;
				border-radius:.8em;
			}
			span.mati_spieler_text {
				position:absolute;
				display:block;
				line-height:1.4em;
				top:.4em;
				bottom:.4em;
				left:1em;
				right:.2em;
				padding-left:1.2em;
				padding-right:.1em;
				background-color:black;
				z-index:1;
				box-shadow:0 0 .2em black;
				overflow:hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			#mati_spieler_container {
				font-size:200%;
			}
			
			#mati_flaggen_container {
				position:absolute;
				bottom:1em;
				left:1em;
				right:1em;
				text-align:center;
			}
			
			img.mati_flagge {
				height:3em;
				width:auto;
				border:.5em solid transparent; 
			}
			@keyframes mati_animation_flagge_aktiv {
				from {
					border-color: rgba(255, 255, 255, 0);
				}
				to {
					border-color: rgba(255, 255, 255, 1)
				}
			}
			img.mati_flagge_aktiv {
				border-color: white;
				animation-name: mati_animation_flagge_aktiv;
				animation-duration: 2s;
				animation-iteration-count: infinite;
				animation-direction: alternate;
			}
			
			#mati_warten_text {
				padding:1em;
				text-align:center;
			}
			
		</style>
		<style id="mati_farbstyle">
		</style>
	</head>
	<body>
		<div id="mati_controller_alles">
			<div id="mati_spieler_container">
			</div>
			<div id="mati_content_container">
				<div id="mati_hauptmenue" class="mati_buttonbox">
					<div id="mati_hauptmenue_buttons">
					</div>
					<div id="mati_flaggen_container">
					</div>
				</div>
				<div id="mati_pausemenue" class="mati_buttonbox">
					<div id="mati_pausemenue_buttons">
					</div>
				</div>
				<div id="mati_wartebild" class="mati_buttonbox">
					<div id="mati_warten_text">
					</div>
				</div>
			</div>
		</div>
		
		<script src="matiUtil.js" rel="script" type="application/javascript"></script>
		<script src="matiFarbutil.js" rel="script" type="application/javascript"></script>
		<script src='https://tiltspot.tv/api/controller/controller-1.0.0.js' rel='script' type='application/javascript'></script>
		<script>
			var mati = {
				farbe : matiFarbutil.WEISS,
				spracheCode : null,
				sprachen : [],
				aktuellSichbarerContainer : null,
				aktuellerContainerLautSpielstatus : null
			};
			
			mati.renderFarbe = function() {
				let hell50dunkel80 = matiFarbutil.toCssString(matiFarbutil.gedimmteFarbe(matiFarbutil.aufgehellteFarbe(mati.farbe, .5), .8));
				let hell50 = matiFarbutil.toCssString(matiFarbutil.aufgehellteFarbe(mati.farbe, .5));
				let dunkel50 = matiFarbutil.toCssString(matiFarbutil.gedimmteFarbe(mati.farbe, .5));
				let dunkel30 = matiFarbutil.toCssString(matiFarbutil.gedimmteFarbe(mati.farbe, .3));
				document.getElementById('mati_farbstyle').innerHTML = `
					body {
						background-color:${dunkel30};
					}
				
					.mati_buttonbox {
						background: ${dunkel50} radial-gradient(circle, ${dunkel50}, ${dunkel30});
						border-color: ${hell50};
					}
					
					.mati_button {
						background: ${hell50} radial-gradient(circle, ${hell50}, ${hell50dunkel80});
					}
					.mati_button_focus {
						background: ${hell50dunkel80} radial-gradient(circle, ${hell50dunkel80}, ${hell50});
					}
					.mati_spieler_img {
						background-color:${hell50};
					}
					.mati_spieler_text {
						color: ${hell50};
						background: ${dunkel50} linear-gradient(135deg, ${dunkel50}, ${dunkel30});
					}
				`;
			};
			
			mati.zeigeContainer = function(containerElement, rueckwaerts, callback) {
				if (containerElement === mati.aktuellSichbarerContainer) {
					callback();
					return;
				}
			
				let breite = document.getElementById('mati_controller_alles').offsetWidth;
				containerElement.style['transition-property'] = 'none';
				containerElement.style['transition-duration'] = '0s';
				
				//TODO aender den code, mach stattdessen ne loesung wo du den Flush-Unsinn nicht brauchst (beim window onresize globale style anpassen)
				
				//Render-Flush um Animations-Abschaltung zu uebernehmen
				containerElement.offsetHeight;
				
				containerElement.style['transform'] = `perspective(${breite*4}px) translateZ(${-breite/2}px) rotateY(${rueckwaerts ? -90 : 90}deg) translateZ(${breite/2}px)`;
				containerElement.style['display'] = 'block';
				containerElement.style['transition-property'] = 'transform';
				containerElement.style['transition-duration'] = '1s';
				
				if (mati.aktuellSichbarerContainer !== null) {
					mati.aktuellSichbarerContainer.style['transition-property'] = 'transform';
					mati.aktuellSichbarerContainer.style['transition-duration'] = '1s';
					//Flush
					mati.aktuellSichbarerContainer.offsetHeight;
				}
				
				//Render-Flush um Animations-Anschaltung zu uebernehmen
				containerElement.offsetHeight;
				containerElement.style['transform'] = `perspective(${breite*4}px) translateZ(${-breite/2}px) rotateY(0deg) translateZ(${breite/2}px)`;
				
				if (mati.aktuellSichbarerContainer !== null) {
					mati.aktuellSichbarerContainer.style['transform'] = `perspective(${breite*4}px) translateZ(${-breite/2}px) rotateY(${rueckwaerts ? 90 : -90}deg) translateZ(${breite/2}px)`;
				}
				
				setTimeout(function () {
					if (mati.aktuellSichbarerContainer !== null) {
						mati.aktuellSichbarerContainer.style['display'] = 'none';
					}
					
					mati.aktuellSichbarerContainer = containerElement;
					if (containerElement.id !== 'mati_pausemenue') {
						mati.aktuellerContainerLautSpielstatus = containerElement;
					}
					callback();
				}, 1000);
			};
			
			
			
			Tiltspot.on.ready = function() {
				Tiltspot.send.msg('clientReady');
			};
			
			Tiltspot.on.msg = function (msg, data) {
				if (document.getElementById('mati_spieler_container').getElementsByClassName('mati_spieler').length === 0) {
					document.getElementById('mati_spieler_container').innerHTML = `
						<div class="mati_spieler">
							<span class="mati_spieler_img">
								<img src="${Tiltspot.get.user().profilePicture}" />
							</span>
							<span class="mati_spieler_text">${matiUtil.htmlEscape(Tiltspot.get.user().nickname)}</span>
						</div>
					`;
				}
				
				if (mati.sprachen.length === 0) {
					matiUtil.pushBefehl(function() {
						if (mati.sprachen.length === 0) {
							matiUtil.loadJson(Tiltspot.get.assetUrl("language-list.json"), function(sprachen) {
								mati.sprachen = sprachen;
								
								document.getElementById('mati_flaggen_container').innerHTML = mati.sprachen.map(function (sprache) {
									return `
										<img id="mati_flagge_code_${sprache.code}" class="${sprache.code === mati.spracheCode ? 'mati_flagge mati_flagge_aktiv' : 'mati_flagge'}" src="${Tiltspot.get.assetUrl(`gui-l10n/${sprache.code}.svg`)}" alt="${Tiltspot.get.assetUrl(`gui-l10n/${sprache.name}.svg`)}" />
									`;
								}).join('');
								
								for (let sprache of mati.sprachen) {
									let spracheCode = sprache.code;
									document.getElementById(`mati_flagge_code_${sprache.code}`).addEventListener('click', function() {
										Tiltspot.send.msg('setSpracheCode', spracheCode);
									});
								}
								
								matiUtil.gotoNaechsterBefehl();
							});
						}
					});
				}
			
				if (data.farbe !== mati.farbe) {
					matiUtil.pushBefehl(function() {
						if (data.farbe !== mati.farbe) {
							mati.farbe = data.farbe;
							mati.renderFarbe();
							matiUtil.gotoNaechsterBefehl();
						}
					});
				}
				
				if (data.spracheCode !== mati.spracheCode) {
					matiUtil.pushBefehl(function() {
						if (data.spracheCode !== mati.spracheCode) {
							mati.spracheCode = data.spracheCode;
							matiUtil.loadJson(Tiltspot.get.assetUrl(`gui-l10n/${mati.spracheCode}.json`), function(guiTexte) {
								matiUtil.l10nTexte = guiTexte;
								
								document.getElementById('mati_warten_text').innerText = matiUtil.l10n('Bitte warten bis die nächste Interaktion möglich ist!');
								
								document.getElementById('mati_hauptmenue_buttons').innerHTML = `
									<div class="mati_button" id="mati_button_neues_spiel">${matiUtil.l10nHtml('Neues Spiel')}</div>
									<div class="mati_button" id="mati_button_beenden">${matiUtil.l10nHtml('Beenden')}</div>
								`;
								
								for (let flaggeElement of document.getElementsByClassName('mati_flagge_aktiv')) {
									flaggeElement.classList.remove('mati_flagge_aktiv');
								}
								document.getElementById(`mati_flagge_code_${mati.spracheCode}`).classList.add('mati_flagge_aktiv');
								
								document.getElementById('mati_pausemenue_buttons').innerHTML = `
									<div class="mati_button" id="mati_button_spiel_fortsetzen">${matiUtil.l10nHtml('Spiel fortsetzen')}</div>
									<div class="mati_button" id="mati_button_spiel_abbrechen">${matiUtil.l10nHtml('Laufendes Spiel abbrechen')}</div>
									<div class="mati_button" id="mati_button_beenden_pausemenue">${matiUtil.l10nHtml('Beenden')}</div>
								`;
								
								matiUtil.gotoNaechsterBefehl();
							});
						}
					});
				}
			
				switch (msg) { 
					case 'zeigeHauptmenue':
						matiUtil.pushBefehl(function() {
							mati.zeigeContainer(document.getElementById('mati_hauptmenue'), false, matiUtil.gotoNaechsterBefehl);
						});
						break;
					case 'zeigeWarten':
						matiUtil.pushBefehl(function() {
							mati.zeigeContainer(document.getElementById('mati_wartebild'), false, matiUtil.gotoNaechsterBefehl);
						});
						break;
				}
			};
			
			
			
			document.getElementById('mati_hauptmenue_buttons').addEventListener('touchstart', function (event) {
				if (!event.target.matches('.mati_button')) {
					return;
				}
				event.target.classList.add('mati_button_focus');
			}, false);
			document.getElementById('mati_hauptmenue_buttons').addEventListener('touchend', function (event) {
				if (!event.target.matches('.mati_button')) {
					return;
				}
				event.target.classList.remove('mati_button_focus');
				
				let boundingClientRect = event.target.getBoundingClientRect();
				
				//Testen ob der Toch auch auf dem Button beendet wurde
				let buttonWurdeGeklickt = false;
				for (let touch of event.changedTouches) {
					if (touch.clientX >= boundingClientRect.left
							&& touch.clientX <= boundingClientRect.right
							&& touch.clientY >= boundingClientRect.top
							&& touch.clientY <= boundingClientRect.bottom) {
						buttonWurdeGeklickt = true;
					}
				}
				
				if (buttonWurdeGeklickt) {
					//Button-Effekt
					let cloneButton = event.target.cloneNode(true);
					let cloneContainer = document.createElement("div");
					cloneContainer.classList.add('mati_buttoneffekt_container');
					cloneContainer.style['top'] = boundingClientRect.top + 'px';
					cloneContainer.appendChild(cloneButton);
					document.getElementById('mati_controller_alles').appendChild(cloneContainer);
					setTimeout(function () {
						document.getElementById('mati_controller_alles').removeChild(cloneContainer);
					}, 1000);
					
					switch (event.target.id) {
						case 'mati_button_neues_spiel':
							Tiltspot.send.msg('neuesSpiel');
							break;
					}
				}
			}, false);
			document.getElementById('mati_hauptmenue_buttons').addEventListener('touchcancel', function (event) {
				if (!event.target.matches('.mati_button')) {
					return;
				}
				event.target.classList.remove('mati_button_focus');
			}, false);

			
			
			var onAenderungDerFenstergroesse = function() {
				var allesFontSize = Math.min(window.innerWidth, window.innerHeight) / 20;
				document.getElementById('mati_controller_alles').style["font-size"] = allesFontSize + "px";
			};
			onAenderungDerFenstergroesse();
			window.addEventListener( 'resize', onAenderungDerFenstergroesse, false );
		</script>
	</body>
</html>