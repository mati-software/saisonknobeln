<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Saisonknobeln</title>
        <style>
			body {
				overflow:hidden;
				padding:0;
				border:0;
				margin:0;
			}        
        
            #mati_canvas {
                position: absolute;
                left: 0;
                top: 0;
                width: 100vw;
                height: 100vh;
            }
            input#mati_spieler_text {
				position:absolute;
				display:block;
				line-height:1.4em;
                height:1.4em;
				top:.4em;
				left:2em;
				width: 7.5em;
                padding: 0 .1em 0 0.2em;
				background-color: transparent;
				overflow:hidden;
                border: 0;
                margin: 0;
                font-size: 100%;
                font-family: Helvetica, Arial, sans-serif;
			}
        </style>
		<script src="matiUtil.js" rel="script" type="application/javascript"></script>
		<script src="matiFarbutil.js" rel="script" type="application/javascript"></script>
        <script src="matiWebglUtil.js"></script>
		<script src='https://tiltspot.tv/api/controller/controller-1.0.0.js' rel='script' type='application/javascript'></script>
    </head>
    <body>
        <canvas id="mati_canvas" width="500" height="500"></canvas>
        <input id="mati_spieler_text" value="Player" />
        <canvas id="mati_canvas_2d" width="500" height="500"   style="display: none"     ></canvas>
        
        <img src="sound.svg" id="mati_musik_button"     style="display: none"      />
        <img src="sound-x.svg" id="mati_musik_button_x"     style="display: none"      />
        <img src="menu-button.svg" id="mati_menu_button"     style="display: none"      />

        <script>
            var mati = {
                em : 45,
                gl : null,
                ctx2d : null,
                glRotation : 0.0,
                windowWidthInEm : 20.0,
                windowHeightInEm : 21.0,
                
                basisfarbeMal255 : null,
				farbe : {r: 1, g: .5, b: 0},
				farbeHell50dunkel80 : {r: .8, g: .6, b: .4},
				farbeHell50 : {r: 1, g: .75, b: .5},
				farbeDunkel50 : {r: .5, g: .25, b: 0},
				farbeDunkel30 : {r: .3, g: .15, b: 0},
				spracheCode : null,
				sprachen : [],
                spracheIstInitialisiert : false,
                spielernameIstInitialisiert : false,
                tiltspotIstInitialisiert : false,
                themeSelectionIstInitialisiert : false,
				buttonMitFokus : null,
                
                verfuegbareThemes : [],
                themeAnzahlTexturspalten : 1,
                aktuellesTheme : 0,
                altesTheme : 0,
                lastDeltaThemeInThemeSelection : 0,
                themeIconsOffset : 0,

                buttonEffektUniqueId : null,
                buttonEffektZoom : 1.5,
                
                mouseposInEmX : 0,
                mouseposInEmY : 0,

				anzahlSpieler : 0,
				schaetzungAntwortA : 8,
				schaetzungAntwortB : 2,
                schaetzungAntwortAFloat : 8,
				gewaehlteAnwortmoeglichkeit : 0,
                textAntwortA : '1',
                textAntwortB : '2',
				
				musikIstEingeschaltet : true,
                pauseButtonEinblendenFloat : 0.0,
                pauseMenueIstAufgeklapptFloat : 0.0,
                
                laufendeAnimationen : [],
                
                flags : ['bg', 'cn', 'cz', 'de', 'dk', 'ee', 'es', 'fi', 'fr', 'gb', 'gr', 'hr', 'hu', 'it', 'lt', 'lv', 'nl', 'no', 'pl', 'pt', 'ro', 'rs', 'ru', 'se', 'si', 'sk', 'tr', 'ua', 'us'],
                flaggenImages : [],
                
                aktuelleRendergruppe : 'hauptmenue',
                vorherigeRendergruppe : null
            };
        </script>
        
        <script src="mati.glProgramObjects.js"></script>
        
        <script>
            mati.renderObjektGruppen = {
                spieler : [
                    {
                        typ : 'spieler',
                        left : 0,
                        top : 0,
                        right : 0,
                        height: 4.4
                    }
                ],
                pauseButton : [
                    {
                        typ : 'pauseButton',
                        top : .8,
                        right : .4,
                        width : 2.8,
                        height : 4.0,
                        onPointerDown : function() {
                            mati.togglePauseMenue();
                        }
                    }
                ],
                pauseMenue : [
                    {
                        typ : 'pauseBackground',
                        top: 4.8,
                        left: 0.4,
                        right: 0.4,
                        bottom: 0.4
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 3,
                        textLine : 3,
                        onClick : function() {
                            mati.pauseMenueAusblenden();
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 9.9,
                        right : 1.5,
                        height : 3,
                        textLine : 2,
                        onClick : function() {
                            mati.pauseMenueAusblenden();
                            Tiltspot.send.msg('spielAbbrechen');
                        }
                    },
                    {
                        typ : 'soundButton',
                        right : function() {
                            return mati.windowWidthInEm / 2 - 2.5;
                        },
                        bottom : 1.5,
                        width : 5,
                        height : 3,
                        textLine : 1,
                        onPointerDown : function() {
                            Tiltspot.send.msg('setSound', !mati.musikIstEingeschaltet);
                        }
                    }
                ],
                pauseMenueSchatten : [
                    {
                        typ : 'pauseMenueSchatten',
                        top: 4.8,
                        left: 0.4,
                        right: 0.4,
                        bottom: 0.4
                    }
                ],
                hauptmenue : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 3,
                        textLine : 0,
                        onClick : function() {
                            Tiltspot.send.msg('neuesSpiel');
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 9.9,
                        right : 1.5,
                        height : 3,
                        textLine : 1,
                        onClick : function() {
                            Tiltspot.exitGame();
                        }
                    },
                    {
                        typ : 'sprachAuswahl',
                        left : function() {
                            return mati.windowWidthInEm / 2 - 1;
                        },
                        bottom : 1.5,
                        width : 8,
                        height : 3,
                        textLine : 1,
                        onPointerDown : function() {
                            let delta = 0;
                            if (this.left() + this.width/2 <= mati.mouseposInEmX) {
                                delta = -1;
                            }
                            else {
                                delta = 1;
                            }
                            let indexAktuelleSprache = mati.getIndexAktuelleSprache();
                            let neueSprache = mati.sprachen[(mati.sprachen.length + indexAktuelleSprache + delta) % mati.sprachen.length];
                            Tiltspot.send.msg('setSpracheCode', neueSprache.code);
                        }
                    },
                    {
                        typ : 'soundButton',
                        right : function() {
                            return mati.windowWidthInEm / 2 + 2;
                        },
                        bottom : 1.5,
                        width : 5,
                        height : 3,
                        textLine : 1,
                        onPointerDown : function() {
                            Tiltspot.send.msg('setSound', !mati.musikIstEingeschaltet);
                        }
                    }
                ],
                bitteWarten : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 0
                    }
                ],
                antwortAuswahl : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 1
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 10.9,
                        right : 1.5,
                        height : 3,
                        textLine : 5,
                        onClick : function() {
                            mati.gewaehlteAnwortmoeglichkeit = 0;
                            mati.schaetzungAntwortA = mati.gewaehlteAnwortmoeglichkeit === 0 ? Math.ceil(mati.anzahlSpieler / 2) : Math.floor(mati.anzahlSpieler / 2);
                            mati.schaetzungAntwortAFloat = mati.schaetzungAntwortA;
                            mati.schaetzungAntwortB = mati.anzahlSpieler - mati.schaetzungAntwortA;
                            mati.zeigeObjektGruppe('schaetzung');
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 14.9,
                        right : 1.5,
                        height : 3,
                        textLine : 6,
                        onClick : function() {
                            mati.gewaehlteAnwortmoeglichkeit = 1;
                            mati.schaetzungAntwortA = mati.gewaehlteAnwortmoeglichkeit === 0 ? Math.ceil(mati.anzahlSpieler / 2) : Math.floor(mati.anzahlSpieler / 2);
                            mati.schaetzungAntwortAFloat = mati.schaetzungAntwortA;
                            mati.schaetzungAntwortB = mati.anzahlSpieler - mati.schaetzungAntwortA;
                            mati.zeigeObjektGruppe('schaetzung');
                        }
                    }
                ],
                themeSelection : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'themeIcon',
                        width : 16,
                        top : 5.9,
                        right : function() {
                            return mati.windowWidthInEm / 2 - 8;
                        },
                        height : 8,
                        theme2 : false
                    },
                    {
                        typ : 'themeIcon',
                        width : 16,
                        top : 5.9,
                        right : function() {
                            return mati.windowWidthInEm / 2 - 8 - 20;
                        },
                        height : 8,
                        theme2 : true
                    },
                    {
                        typ : 'bigButton',
                        left : 5.5,
                        top : 14.9,
                        right : 5.5,
                        height : 3,
                        textLine : 4,
                        onClick : function() {
                            Tiltspot.send.msg('themeSelectionOk');
                        }
                    },
                    {
                        typ : 'smallButton',
                        left : 1.5,
                        top : 14.9,
                        width : 3,
                        height : 3,
                        textLine : 10,
                        onPointerDown : function() {
                            Tiltspot.send.msg('prevTheme');
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : 1.5,
                        top : 14.9,
                        width : 3,
                        height : 3,
                        textLine : 11,
                        onPointerDown : function() {
                            Tiltspot.send.msg('nextTheme');
                        }
                    }
                ],
                
                schaetzung : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'mehrzeiligerText',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 4,
                        textLine : 2
                    },
                    {
                        typ : 'einzeiligerText',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 10.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 10.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 10.9;
                        },
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        height : 2,
                        textLine : 5
                    },
                    {
                        typ : 'schaetzungBalken',
                        left : 5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.9 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.9 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 13.4;
                        },
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + 4;
                            }
                            return 5;
                        },
                        height : 2,
                        zeigeWertB : 0
                    },
                    {
                        typ : 'smallButton',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 12.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 12,
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortA > 0) {
                                mati.schaetzungAntwortA -= 1;
                                mati.schaetzungAntwortB += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 12.4 + (mati.windowHeightInEm - 26.4) / 4;
                            }
                            return 12.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 13,
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortB > 0) {
                                mati.schaetzungAntwortB -= 1;
                                mati.schaetzungAntwortA += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'einzeiligerText',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 10.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 15.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 16.9;
                        },
                        right : 1.5,
                        height : 2,
                        textLine : 6,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        }
                    },
                    {
                        typ : 'schaetzungBalken',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + 4;
                            }
                            return 5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.9 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 18.4 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 19.4;
                        },
                        right : 5,
                        height : 2,
                        zeigeWertB : 1,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        }
                    },
                    {
                        typ : 'smallButton',
                        left : function() {
                            if (mati.windowWidthInEm >= 36) {
                                return mati.windowWidthInEm / 2 + .5;
                            }
                            return 1.5;
                        },
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 17.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 18.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 12,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        },
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortB > 0) {
                                mati.schaetzungAntwortB -= 1;
                                mati.schaetzungAntwortA += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'smallButton',
                        right : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 26.4) {
                                return 12.4 + (mati.windowHeightInEm - 20.9) / 2;
                            }
                            if (mati.windowHeightInEm < 28.4) {
                                return 17.9 + (mati.windowHeightInEm - 26.4) / 2;
                            }
                            return 18.9;
                        },
                        width : 3,
                        height : 3,
                        textLine : 13,
                        ausblenden : function () {
                            return mati.windowWidthInEm < 36 && mati.windowHeightInEm < 26.4;
                        },
                        onPointerDown : function() {
                            if (mati.schaetzungAntwortA > 0) {
                                mati.schaetzungAntwortA -= 1;
                                mati.schaetzungAntwortB += 1;
                                mati.animateSchaetzung();
                            }
                        }
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : function() {
                            if (mati.windowHeightInEm < 28.4) {
                                return null;
                            }
                            return 23.9;
                        },
                        bottom : function() {
                            if (mati.windowHeightInEm < 28.4) {
                                return 1.5;
                            }
                            return null;
                        },
                        right : 1.5,
                        height : 3,
                        textLine : 4,
                        onClick : function() {
                            Tiltspot.send.msg('antwortAbgeben', {
                                antwort: mati.gewaehlteAnwortmoeglichkeit,
                                schaetzungAntwortA : mati.schaetzungAntwortA,
                                schaetzungAntwortB : mati.schaetzungAntwortB
                            });
                            mati.zeigeObjektGruppe('bitteWarten');
                        }
                    }
                ],
                spielAbschliessen : [
                    {
                        typ : 'borderedBox',
                        left : 0,
                        top : 4.4,
                        right : 0,
                        bottom: 0
                    },
                    {
                        typ : 'bigButton',
                        left : 1.5,
                        top : 5.9,
                        right : 1.5,
                        height : 3,
                        textLine : 7,
                        onClick : function() {
                            Tiltspot.send.msg('spielAbschliessen');
                        }
                    }
                ]
            };
            
            mati.readValueFromFunctionOrPrimitive = function(elementObject, attributeName) {
                if (typeof elementObject[attributeName] === 'number'
                        || typeof elementObject[attributeName] === 'boolean') {
                    return elementObject[attributeName];
                }
                if (typeof elementObject[attributeName] === 'function') {
                    return elementObject[attributeName]();
                }
                return null;
            };
            
            mati.getRenderObjektKoordinatenInEm = function(elementObject) {
                let attributeLeft = mati.readValueFromFunctionOrPrimitive(elementObject, 'left');
                let attributeTop = mati.readValueFromFunctionOrPrimitive(elementObject, 'top');
                let attributeRight = mati.readValueFromFunctionOrPrimitive(elementObject, 'right');
                let attributeBottom = mati.readValueFromFunctionOrPrimitive(elementObject, 'bottom');
                let attributeWidth = mati.readValueFromFunctionOrPrimitive(elementObject, 'width');
                let attributeHeight = mati.readValueFromFunctionOrPrimitive(elementObject, 'height');
            
                let x = attributeLeft !== null ? attributeLeft : mati.windowWidthInEm - attributeRight - attributeWidth;
                let y = attributeTop !== null ? attributeTop : mati.windowHeightInEm - attributeBottom - attributeHeight;
                let width = attributeWidth !== null ? attributeWidth : mati.windowWidthInEm - attributeRight - attributeLeft;
                let height = attributeHeight !== null ? attributeHeight : mati.windowHeightInEm - attributeBottom - attributeTop;
                return {x:x, y:y, width:width, height:height};
            };
            
            mati.animateSchaetzung = function() {
                mati.cancelLaufendeAnimation('schaetzungAntwortAFloat');
                let highResTimeStamp = window.performance.now();
                mati.laufendeAnimationen.push({
                    matiAttribute : 'schaetzungAntwortAFloat',
                    startValue : mati.schaetzungAntwortAFloat,
                    endValue : mati.schaetzungAntwortA,
                    startTime : highResTimeStamp,
                    endTime : highResTimeStamp + 250
                });
            };
            
            mati.getLaufendeAnimationByMatiAttribute = function(matiAttribute) {
                for (let laufendeAnimation of mati.laufendeAnimationen) {
                    if (laufendeAnimation.matiAttribute === matiAttribute) {
                        return laufendeAnimation;
                    }
                }
                return null;
            };
            
            mati.getZweiteLaufendeAnimationByMatiAttribute = function(matiAttribute) {
                var ersteBereitsGefunden = false;
                for (let laufendeAnimation of mati.laufendeAnimationen) {
                    if (laufendeAnimation.matiAttribute === matiAttribute) {
                        if (ersteBereitsGefunden) {
                            return laufendeAnimation;
                        }
                        else {
                            ersteBereitsGefunden = true;
                        }
                    }
                }
                return null;
            };
            
            mati.getIndexOfLaufendeAnimationByMatiAttribute = function(matiAttribute) {
                for (let index = 0; index < mati.laufendeAnimationen.length; index++) {
                    if (mati.laufendeAnimationen[index].matiAttribute === matiAttribute) {
                        return index;
                    }
                }
                return -1;
            };
            
            mati.cancelLaufendeAnimation = function(matiAttribute) {
                let index = mati.getIndexOfLaufendeAnimationByMatiAttribute(matiAttribute);
                if (index >= 0) {
                    mati.laufendeAnimationen.splice(index, 1);
                }
            };
            
            mati.zeigeObjektGruppe = function(key) {
                if (key === mati.aktuelleRendergruppe) {
                    //Die richtige Gruppe wird bereits angezeigt
                    let nachfolgendeAnimation = mati.getZweiteLaufendeAnimationByMatiAttribute('glRotation');
                    if (nachfolgendeAnimation !== null) {
                        //Nachfolgende Animation loeschen
                        let zuLoeschenderIndex = mati.laufendeAnimationen.indexOf(nachfolgendeAnimation);
                        mati.laufendeAnimationen.splice(zuLoeschenderIndex, 1);
                    }
                    return;
                }
            
                let bereitsLaufendeAnimation = mati.getLaufendeAnimationByMatiAttribute('glRotation');
                if (bereitsLaufendeAnimation !== null) {
                    let nachfolgendeAnimation = mati.getZweiteLaufendeAnimationByMatiAttribute('glRotation');
                    if (nachfolgendeAnimation !== null) {
                        nachfolgendeAnimation.onStart = function() {
                            mati.vorherigeRendergruppe = mati.aktuelleRendergruppe;
                            mati.aktuelleRendergruppe = key;
                        };
                    }
                    else {
                        mati.laufendeAnimationen.push({
                            matiAttribute : 'glRotation',
                            startValue : -Math.PI/2,
                            endValue : 0,
                            startTime : bereitsLaufendeAnimation.endTime,
                            endTime : bereitsLaufendeAnimation.endTime + 1000,
                            onStart : function() {
                                mati.vorherigeRendergruppe = mati.aktuelleRendergruppe;
                                mati.aktuelleRendergruppe = key;
                            }
                        });
                    }
                    return;
                }

                mati.vorherigeRendergruppe = mati.aktuelleRendergruppe;
                mati.aktuelleRendergruppe = key;
                mati.glRotation = -Math.PI/2;
                
                let highResTimeStamp = window.performance.now();
                
                mati.laufendeAnimationen.push({
                    matiAttribute : 'glRotation',
                    startValue : -Math.PI/2,
                    endValue : 0,
                    startTime : highResTimeStamp,
                    endTime : highResTimeStamp + 1000
                });
                
                //Menue-Button ein- oder ausblenden
                let bereitsLaufendePauseButtonAnimation = mati.getLaufendeAnimationByMatiAttribute('pauseButtonEinblendenFloat');
                if (key === 'hauptmenue') {
                    if (bereitsLaufendePauseButtonAnimation !== null
                            ? bereitsLaufendePauseButtonAnimation.endValue !== 0.0
                            : mati.pauseButtonEinblendenFloat !== 0.0) {
                        mati.cancelLaufendeAnimation('pauseButtonEinblendenFloat');
                        mati.laufendeAnimationen.push({
                            matiAttribute : 'pauseButtonEinblendenFloat',
                            startValue : mati.pauseButtonEinblendenFloat,
                            endValue : 0.0,
                            startTime : highResTimeStamp,
                            endTime : highResTimeStamp + 500 * mati.pauseButtonEinblendenFloat
                        });
                    }
                }
                else {
                    if (bereitsLaufendePauseButtonAnimation !== null
                            ? bereitsLaufendePauseButtonAnimation.endValue !== 1.0
                            : mati.pauseButtonEinblendenFloat !== 1.0) {
                        mati.cancelLaufendeAnimation('pauseButtonEinblendenFloat');
                        mati.laufendeAnimationen.push({
                            matiAttribute : 'pauseButtonEinblendenFloat',
                            startValue : mati.pauseButtonEinblendenFloat,
                            endValue : 1.0,
                            startTime : highResTimeStamp,
                            endTime : highResTimeStamp + 500 * (1.0 - mati.pauseButtonEinblendenFloat)
                        });
                    }
                }
            };
            
            
            
            mati.isButtonUnterAktuellerMousePosition = function(elementObject) {
                let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
            
                if (mati.mouseposInEmY >= buttonKoordinaten.y
                        && mati.mouseposInEmY <= buttonKoordinaten.y + 3) {
                    if (mati.mouseposInEmX >= buttonKoordinaten.x + 1.5
                            && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width - 1.5) {
                        return true;
                    }
                    if (mati.mouseposInEmX >= buttonKoordinaten.x
                            && mati.mouseposInEmX <= buttonKoordinaten.x + 1.5) {
                        let deltaX = buttonKoordinaten.x + 1.5 - mati.mouseposInEmX;
                        let deltaY = buttonKoordinaten.y + 1.5 - mati.mouseposInEmY;
                        let deltaXNorm = deltaX / 1.5;
                        let deltaYNorm = deltaY / 1.5;
                        return deltaXNorm * deltaXNorm + deltaYNorm * deltaYNorm <= 1;
                    }
                    if (mati.mouseposInEmX >= buttonKoordinaten.x + buttonKoordinaten.width - 1.5
                            && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                        let deltaX = buttonKoordinaten.x + buttonKoordinaten.width - 1.5 - mati.mouseposInEmX;
                        let deltaY = buttonKoordinaten.y + 1.5 - mati.mouseposInEmY;
                        let deltaXNorm = deltaX / 1.5;
                        let deltaYNorm = deltaY / 1.5;
                        return deltaXNorm * deltaXNorm + deltaYNorm * deltaYNorm <= 1;
                    }
                }
                return false;
            };
            
            mati.getTouchedButtonObject = function() {
                if (mati.pauseButtonEinblendenFloat === 1.0) {
                    for (let elementObject of mati.renderObjektGruppen.pauseButton) {
                        if (elementObject.typ === 'pauseButton') {
                            let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
                            //TODO border-radius beachten?
                            if (mati.mouseposInEmY >= buttonKoordinaten.y
                                    && mati.mouseposInEmY <= buttonKoordinaten.y + buttonKoordinaten.height
                                    && mati.mouseposInEmX >= buttonKoordinaten.x
                                    && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                                return elementObject;
                            }
                        }
                    }
                }
                
                if (mati.pauseMenueIstAufgeklapptFloat === 1.0) {
                    for (let elementObject of mati.renderObjektGruppen.pauseMenue) {
                        if (elementObject.typ === 'bigButton') {
                            if (mati.isButtonUnterAktuellerMousePosition(elementObject)) {
                                return elementObject;
                            }
                        }
                        if (elementObject.typ === 'soundButton') {
                            let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
                            if (mati.mouseposInEmY >= buttonKoordinaten.y
                                    && mati.mouseposInEmY <= buttonKoordinaten.y + buttonKoordinaten.height
                                    && mati.mouseposInEmX >= buttonKoordinaten.x
                                    && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                                return elementObject;
                            }
                        }
                    }
                }

                if (mati.getLaufendeAnimationByMatiAttribute('glRotation') || mati.pauseMenueIstAufgeklapptFloat !== 0.0) {
                    return null;
                }

                for (let elementObject of mati.renderObjektGruppen[mati.aktuelleRendergruppe]) {
                    if (elementObject.typ === 'bigButton'
                            || elementObject.typ === 'smallButton'
                            || elementObject.typ === 'sprachAuswahl') {
                        if (mati.isButtonUnterAktuellerMousePosition(elementObject)) {
                            return elementObject;
                        }
                    }
                    if (elementObject.typ === 'soundButton') {
                        let buttonKoordinaten = mati.getRenderObjektKoordinatenInEm(elementObject);
                        if (mati.mouseposInEmY >= buttonKoordinaten.y
                                && mati.mouseposInEmY <= buttonKoordinaten.y + buttonKoordinaten.height
                                && mati.mouseposInEmX >= buttonKoordinaten.x
                                && mati.mouseposInEmX <= buttonKoordinaten.x + buttonKoordinaten.width) {
                            return elementObject;
                        }
                    }
                }

                return null;
            };
            
            //Wird von Pointer-, Maus- und Touch-Events genutzt (iOS kann keine Pointer-Events). Daher muss sichergestellt werden, dass die Aktion nur einmal ausgefuehrt wird.
            mati.onPointerDown = function(event, target, mouseposInEmX, mouseposInEmY) {
                if (document.getElementById('mati_spieler_text') === document.activeElement) {
                    //Nichts ausfuehren und keine preventDefault, damit man sicher per Touch den Fokus entfernen kann
                    //TODO ggf doch was tun bei multitouch?
                    return;
                }
                
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();
				
                if (touchedButton !== null) {
                    event.preventDefault();
                }
                
				if (touchedButton !== null && mati.buttonMitFokus === null) {
					mati.buttonMitFokus = touchedButton;
					
					//Kleine Buttons schon bei touchstart ausloesen
					if (touchedButton.onPointerDown) {
                        touchedButton.onPointerDown();
					}
				}
            };
            
            mati.onPointerUp = function (event, target, mouseposInEmX, mouseposInEmY) {
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();
                
				if (touchedButton !== null) {
                    event.preventDefault();
                }
            
				if (touchedButton !== null && mati.buttonMitFokus === touchedButton && touchedButton.onClick) {
					if (touchedButton.typ === 'bigButton') {
						//Button-Effekt
                        
                        //falls noch eine alte animation laeuft, muss die gefinished werden
                        mati.cancelLaufendeAnimation('buttonEffektZoom');
                        
                        mati.buttonEffektUniqueId = touchedButton.uniqueId;

                        mati.buttonEffektZoom = 1;
                        let highResTimeStamp = window.performance.now();
                        mati.laufendeAnimationen.push({
                            matiAttribute : 'buttonEffektZoom',
                            startValue : 1,
                            endValue : 2,
                            startTime : highResTimeStamp,
                            endTime : highResTimeStamp + 1000,
                            onFinish : function() {
                                mati.buttonEffektUniqueId = null;
                            }
                        });
                    }
                    touchedButton.onClick();
				}

                //Im Zweifel einfach auf alle Up-Events reagieren, selbst wenn target nicht stimmt
                mati.buttonMitFokus = null;
			};
            
            mati.onPointerMove = function (event, target, mouseposInEmX, mouseposInEmY) {
                mati.mouseposInEmX = mouseposInEmX;
                mati.mouseposInEmY = mouseposInEmY;
                
                let touchedButton = mati.getTouchedButtonObject();

				if (touchedButton !== null) {
                    event.preventDefault();
                }

				if (touchedButton !== mati.buttonMitFokus) {
					mati.buttonMitFokus = null;
				}
			};
            
            mati.onPointerCancel = function (event, target, mouseposInEmX, mouseposInEmY) {
                //FIXME cancel wird zu haeufig aufgerufen
                //mati.buttonMitFokus = null;
            };
            
            
            
            mati.onWindowResize = function() {
                //TODO FIXME das hier muss mit einsatzverzoegerung sein (debounce)
                mati.setEmAndCreateVertecies();
            };
            
            
            mati.initNachdemGlUndFarbeUndSpracheInitialisiertWurden = function() {
                document.getElementById('mati_spieler_text').style['color'] = 'rgb(' + Math.round(mati.farbeHell50.r * 255) + ', ' + Math.round(mati.farbeHell50.g * 255) + ', ' + Math.round(mati.farbeHell50.b * 255) + ')';
                mati.gl.clearColor(mati.farbeDunkel30.r, mati.farbeDunkel30.g, mati.farbeDunkel30.b, 1);

            
                mati.setEmAndCreateVertecies();
                window.addEventListener('resize', mati.onWindowResize);
                
                document.addEventListener('touchstart', function(event) {
                    //target steht zwar auch direkt im event, allerdings keine Koordinaten
                    mati.onPointerDown(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointerdown', function(event) {
                    //FIXME nur auf pen hoeren (oder anders als 'mouse'/'touch')! ... teste ob beim pen ggf. auch immer einer der anderen events feuert
                    if (event.pointerType !== "mouse" || event.button === 0) {
                        mati.onPointerDown(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });
                document.addEventListener('mousedown', function(event) {
                    if (event.button === 0) { //linker Maus-Button
                        mati.onPointerDown(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });
                
                document.addEventListener('touchend', function (event) {
                    mati.onPointerUp(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointerup', function (event) {
                    //FIXME nur auf pen hoeren!
                    mati.onPointerUp(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                document.addEventListener('mouseup', function (event) {
                    if (event.button === 0) { //linker Maus-Button
                        mati.onPointerUp(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                    }
                });            

                document.addEventListener('touchmove', function (event) {
                    mati.onPointerMove(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointermove', function (event) {
                    //FIXME nur auf pen hoeren!
                    mati.onPointerMove(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                document.addEventListener('mousemove', function (event) {
                    mati.onPointerMove(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });            
                
                document.addEventListener('touchcancel', function (event) {
                    mati.onPointerCancel(event, event.changedTouches[0].target, event.changedTouches[0].clientX * window.devicePixelRatio / mati.em, event.changedTouches[0].clientY * window.devicePixelRatio / mati.em);
                });
                document.addEventListener('pointercancel', function (event) {
                    mati.onPointerCancel(event, event.target, event.clientX * window.devicePixelRatio / mati.em, event.clientY * window.devicePixelRatio / mati.em);
                });
                
                //Spielername
                let inputDomElement = document.getElementById('mati_spieler_text');
                inputDomElement.addEventListener('focus', function() {
                    //Cursor am ende positionieren
                    let pos = inputDomElement.value.length;
                    if (inputDomElement.createTextRange) {
                        var textRange = inputDomElement.createTextRange();
                        textRange.collapse(true);
                        textRange.moveEnd(pos);
                        textRange.moveStart(pos);
                        textRange.select();
                    }
                    else if (inputDomElement.setSelectionRange) {
                        inputDomElement.setSelectionRange(pos,pos);
                    }
                });
                inputDomElement.addEventListener('keyup', function(event) {
                    if (event.keyCode === 13) {
                        inputDomElement.blur();
                    }
                });
                inputDomElement.addEventListener('change', function() {
                    Tiltspot.send.msg('setUsername', inputDomElement.value);
                });
                
                window.requestAnimationFrame(mati.repaint);
            };
            
            mati.setEmAndCreateVertecies = function() {
                var width = window.innerWidth * window.devicePixelRatio;
                var height = window.innerHeight * window.devicePixelRatio;
                
                let em1 = width / 20;
                let em2 = height / 20.9;
                mati.em = Math.min(em1, em2);
                
                document.getElementById('mati_spieler_text').style['font-size'] = (mati.em / window.devicePixelRatio * 2) + 'px';
                
                mati.windowWidthInEm = width / mati.em;
                mati.windowHeightInEm = height / mati.em;
                
                mati.gl.canvas.width = width;
                mati.gl.canvas.height = height;
                mati.gl.viewport(0, 0, mati.gl.drawingBufferWidth, mati.gl.drawingBufferHeight);
                
                for (let programObjectKey in mati.glProgramObjects) {
                    programObject = mati.glProgramObjects[programObjectKey];
                    mati.gl.useProgram(programObject.program);
                    
                    let verticesArray = [];
                    let indicesArray = [];
                    let vertexStartIndexUndAnzahlProElementGruppe = {};
                    let vertexStartIndexUndAnzahlProElement = {};
                    for (let renderObjektGruppeKey in mati.renderObjektGruppen) {
                        vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey] = {
                            startIndex : indicesArray.length,
                            nPoints : 0
                        };
                        let renderObjektGruppe = mati.renderObjektGruppen[renderObjektGruppeKey];
                        for (let elementObject of renderObjektGruppe) {
                            vertexStartIndexUndAnzahlProElement[elementObject.uniqueId] = {
                                startIndex : indicesArray.length,
                                nPoints : 0
                            };
                            if (!mati.readValueFromFunctionOrPrimitive(elementObject, 'ausblenden')) {
                                programObject.befuelleVertexArray(elementObject, verticesArray, indicesArray);
                                vertexStartIndexUndAnzahlProElement[elementObject.uniqueId].nPoints = indicesArray.length - vertexStartIndexUndAnzahlProElement[elementObject.uniqueId].startIndex;
                            }
                        }
                        vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey].nPoints = indicesArray.length - vertexStartIndexUndAnzahlProElementGruppe[renderObjektGruppeKey].startIndex;
                    }
                    matiWebglUtil.befuelleAttributeBuffer(mati.gl, verticesArray, indicesArray, programObject.vertexBuffer, programObject.indexBuffer);
                    
                    programObject.verticesArray = verticesArray;
                    programObject.vertexStartIndexUndAnzahlProElementGruppe = vertexStartIndexUndAnzahlProElementGruppe;
                    programObject.vertexStartIndexUndAnzahlProElement = vertexStartIndexUndAnzahlProElement;
                }
                
                mati.updateSpielerTextInputSize();
            };
            
            mati.executeProgram = function(programObject, vertexStartIndexUndAnzahl, rotation, zoom) {
                mati.gl.useProgram(programObject.program);
                mati.gl.bindBuffer(mati.gl.ARRAY_BUFFER, programObject.vertexBuffer);
                mati.gl.bindBuffer(mati.gl.ELEMENT_ARRAY_BUFFER, programObject.indexBuffer);
                matiWebglUtil.setAttributePointerAndEnableAttributeArray(mati.gl, programObject.program, programObject.verticesArray);
                programObject.setUniforms(rotation, zoom);
                mati.gl.drawElements(mati.gl.TRIANGLES, vertexStartIndexUndAnzahl.nPoints, mati.gl.UNSIGNED_SHORT, vertexStartIndexUndAnzahl.startIndex * 2);
                matiWebglUtil.disableAttributeArray(mati.gl, programObject.program, programObject.verticesArray);
            };
            
            mati.calculateSpielerTextLaengenReduktion = function() {
                let benoetigterPlatzFuerButton = mati.pauseButtonEinblendenFloat * 3.2;
                let uebrigerPlatzBeiVollerLaenge = mati.windowWidthInEm - 20;
                if (uebrigerPlatzBeiVollerLaenge < benoetigterPlatzFuerButton) {
                    return benoetigterPlatzFuerButton - uebrigerPlatzBeiVollerLaenge;
                }
                return 0;
            };
            
            mati.updateSpielerTextInputSize = function() {
                document.getElementById('mati_spieler_text').style['width'] = (7.5 - mati.calculateSpielerTextLaengenReduktion() / 2) + 'em';
            };
            
            mati.repaint = function(now) {
                //Testcode framerate
                /*
                if (mati.testNow) {
                    mati.testAnzahlFrames++;
                    let vergangeneZeit = now - mati.testNow;
                    if (vergangeneZeit > 60000) {
                        let framesPerSecond = mati.testAnzahlFrames / vergangeneZeit * 1000;
                        console.log('framesPerSecond', framesPerSecond);
                        mati.testNow = now;
                        mati.testAnzahlFrames = 0;
                    }
                }
                else {
                    mati.testNow = now;
                    mati.testAnzahlFrames = 0;
                }
                */
            
                for (let i = 0; i < mati.laufendeAnimationen.length; i++) {
                    let animation = mati.laufendeAnimationen[i];
                    if (animation.startTime <= now) {
                        if (animation.onStart) {
                            animation.onStart();
                            delete animation.onStart;
                        }
                        if (animation.endTime <= now) {
                            mati[animation.matiAttribute] = animation.endValue;
                            mati.laufendeAnimationen.splice(i, 1);
                            i--;
                            if (animation.onFinish) {
                                animation.onFinish();
                            }
                        }
                        else {
                            //TODO ease-Functions   siehe https://easings.net/
                            let vergangen = now - animation.startTime;
                            let gesamt = animation.endTime - animation.startTime;
                            let vergangenerBruchteil = vergangen / gesamt;
                            mati[animation.matiAttribute] = animation.startValue * (1-vergangenerBruchteil) + animation.endValue * vergangenerBruchteil;
                        }
                        //Spezialfall Input-Element
                        if (animation.matiAttribute === 'pauseButtonEinblendenFloat') {
                            mati.updateSpielerTextInputSize();
                        }
                    }
                }
                
                mati.gl.clear(mati.gl.COLOR_BUFFER_BIT);
                
                mati.paintRendergruppe('spieler', 0, 1);
                mati.paintRendergruppe(mati.aktuelleRendergruppe, mati.glRotation, 1);
                if (mati.glRotation !== 0) {
                    let rotationAlteBox = mati.glRotation + Math.PI/2;
                    mati.paintRendergruppe(mati.vorherigeRendergruppe, rotationAlteBox, 1);
                }
                if (mati.pauseMenueIstAufgeklapptFloat === 1.0) {
                    mati.paintRendergruppe('pauseMenueSchatten', 0, mati.pauseMenueIstAufgeklapptFloat);
                }
                if (mati.pauseMenueIstAufgeklapptFloat > 0.0) {
                    mati.paintRendergruppe('pauseMenue', 0, mati.pauseMenueIstAufgeklapptFloat);
                }
                mati.paintRendergruppe('pauseButton', 0, 1);

                if (mati.buttonEffektUniqueId !== null) {
                    let programObject = mati.glProgramObjects.buttonEffekt;
                    let vertexStartIndexUndAnzahl = programObject.vertexStartIndexUndAnzahlProElement[mati.buttonEffektUniqueId];
                    mati.executeProgram(programObject, vertexStartIndexUndAnzahl, 0);
                }
                
                window.requestAnimationFrame(mati.repaint);
            };
            
            mati.paintRendergruppe = function(rendergruppeKey, rotation, zoom) {
                for (let programObjectKey in mati.glProgramObjects) {
                    if (programObjectKey !== 'buttonEffekt') {
                        let programObject = mati.glProgramObjects[programObjectKey];
                        let vertexStartIndexUndAnzahl = programObject.vertexStartIndexUndAnzahlProElementGruppe[rendergruppeKey];
                        if (vertexStartIndexUndAnzahl.nPoints > 0) {
                            mati.executeProgram(programObject, vertexStartIndexUndAnzahl, rotation, zoom);
                        }
                    }
                }
            };
            
            mati.canvas2dCreateLineBreaks = function(ctx, words, maxWidthInPx, maxNumberOfLines) {
                let lines = [];
                let textPasst = true;
                let wordIndex = 0;
                while (wordIndex < words.length) {
                    if (lines.length === maxNumberOfLines) {
                        //Es ist noch text uebrig, aber die maximale Zeilenzahl ist bereits erreicht
                        return null;
                    }
                    let line = words[wordIndex++];
                    if (ctx.measureText(line).width > maxWidthInPx) {
                        //das einzelne Wort ist bereits zu lang
                        return null;
                    }
                    while (wordIndex < words.length) {
                        let lineMitEinemWortMehr = line + ' ' + words[wordIndex];
                        if (ctx.measureText(lineMitEinemWortMehr).width > maxWidthInPx) {
                            break;
                        }
                        line = lineMitEinemWortMehr;
                        wordIndex++;
                    }
                    lines.push(line);
                }
                return lines;
            };
            
            mati.canvas2dRenderText = function(ctx, text, x, y, maxWidthInPx, maxHeightInPx, font, fontSizeInPx, lineHeightInPx, bold = false) {
                let words = text.split(' ');
                let lines;
                let angepassteLineHeightInPx;
                let angepassteFontSizeInPx = fontSizeInPx;
                for (let i=0; i<20; i++) {
                    ctx.font = (bold ? 'bold ' : '') + angepassteFontSizeInPx + "px " + font;
                    angepassteLineHeightInPx = Math.ceil(lineHeightInPx * angepassteFontSizeInPx / fontSizeInPx);
                    
                    let maxNumberOfLines = Math.floor(maxHeightInPx / angepassteLineHeightInPx);
                    lines = mati.canvas2dCreateLineBreaks(ctx, words, maxWidthInPx, maxNumberOfLines);
                    if (lines !== null) {
                        break;
                    }

                    angepassteFontSizeInPx *= .9;
                }
                
                if (lines !== null) {
                    for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                        let yOffset = (lineIndex - (lines.length-1)/2) * angepassteLineHeightInPx;
                        ctx.fillText(lines[lineIndex], x, y + yOffset);
                    }
                }
            };
            
            mati.renderTexture0 = function() {
                mati.ctx2d.clearRect(0, 0, 2048, 2048);
            
                let emGerundet = 2048 / 32;
                
                const font = 'Arial';
                const fontSize = emGerundet;
                const lineHeight = emGerundet * 1.3;
                
                mati.ctx2d.fillStyle = "white";
                mati.ctx2d.textAlign = "center";
                mati.ctx2d.textBaseline = "middle";
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('New Game'),
                        emGerundet * 8, emGerundet, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Exit'),
                        emGerundet * 8, emGerundet * 3, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Cancel Game'),
                        emGerundet * 8, emGerundet * 5, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Resume Game'),
                        emGerundet * 8, emGerundet * 7, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, 'OK',
                        emGerundet * 8, emGerundet * 9, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, mati.textAntwortA,
                        emGerundet * 8, emGerundet * 11, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, mati.textAntwortB,
                        emGerundet * 8, emGerundet * 13, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('End game'),
                        emGerundet * 8, emGerundet * 15, //Mittelpunkt-Pos
                        emGerundet * 16, emGerundet * 2, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                //Pfeil links
                mati.ctx2d.beginPath();
                mati.ctx2d.moveTo(emGerundet*7.5, emGerundet*21);
                mati.ctx2d.lineTo(emGerundet*8.25, emGerundet*20.25);
                mati.ctx2d.lineTo(emGerundet*8.25, emGerundet*21.75);
                mati.ctx2d.fill();                
                //Pfeil rechts
                mati.ctx2d.beginPath();
                mati.ctx2d.moveTo(emGerundet*8.5, emGerundet*23);
                mati.ctx2d.lineTo(emGerundet*7.75, emGerundet*22.25);
                mati.ctx2d.lineTo(emGerundet*7.75, emGerundet*23.75);
                mati.ctx2d.fill();                
                //Minus
                mati.ctx2d.fillRect(emGerundet*7.25, emGerundet*24.875, emGerundet*1.5, emGerundet*0.25);
                //Plus
                mati.ctx2d.fillRect(emGerundet*7.25, emGerundet*26.875, emGerundet*1.5, emGerundet*0.25);
                mati.ctx2d.fillRect(emGerundet*7.875, emGerundet*26.25, emGerundet*0.25, emGerundet*1.5);
                //Ziffern
                for (let i=0; i<79; i++) {
                    let reihe = Math.floor(i / 8);
                    let spalte = i % 8;
                    mati.canvas2dRenderText(mati.ctx2d, i + '', emGerundet * (17 + spalte*2), emGerundet * (1 + reihe*2), emGerundet * 2, emGerundet * 2, 'Arial', emGerundet, emGerundet * 1.4, true);
                }
                
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Please wait until the next interaction is possible!'),
                        23.5*emGerundet, 22*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Choose an answer! Keep your choice secret from the other players!'),
                        23.5*emGerundet, 26*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);
                mati.canvas2dRenderText(
                        mati.ctx2d, matiUtil.l10n('Guess how many players (including yourself) have voted for each answer!'),
                        23.5*emGerundet, 30*emGerundet, //Mittelpunkt-Pos
                        emGerundet * 17, emGerundet * 4, //Groesse
                        font,
                        fontSize,
                        lineHeight);

                
                mati.ctx2d.drawImage(document.getElementById('mati_musik_button'), 0, 21*emGerundet, 5*emGerundet, 3*emGerundet);
                mati.ctx2d.drawImage(document.getElementById('mati_musik_button_x'), 0, 25*emGerundet, 5*emGerundet, 3*emGerundet);
                mati.ctx2d.drawImage(document.getElementById('mati_menu_button'), 0, 29*emGerundet, 3*emGerundet, 3*emGerundet);

                mati.gl.activeTexture(mati.gl.TEXTURE0);
                mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.ALPHA, mati.gl.ALPHA, mati.gl.UNSIGNED_BYTE, mati.ctx2d.canvas);
                mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
            };
            
            mati.initNeueSprache = function() {
                if (mati.sprachen.length && mati.spracheCode) {
                    let spracheIstBereitsGeladen = false;
                    for (let sprache of mati.sprachen) {
                        if (sprache.code === mati.spracheCode) {
                            matiUtil.l10nTexte = sprache.texte;
                            spracheIstBereitsGeladen = true;
                            break;
                        }
                    }
                    if (mati.gl && spracheIstBereitsGeladen) {
                        mati.renderTexture0();
                        if (!mati.spracheIstInitialisiert) {
                            mati.spracheIstInitialisiert = true;
                            if (mati.basisfarbeMal255) {
                                mati.initNachdemGlUndFarbeUndSpracheInitialisiertWurden();
                            }
                        }
                    }
                }
            };
            
            
            mati.getIndexAktuelleSprache = function() {
                let indexAktuelleSprache = 0;
                for (let sprache of mati.sprachen) {
                    if (sprache.code === mati.spracheCode) {
                        break;
                    }
                    indexAktuelleSprache++;
                }
                return indexAktuelleSprache;
            };
            
            mati.initFlaggen = function() {
                if (mati.tiltspotIstInitialisiert && mati.gl) {
                    let zuLadendeBilder = mati.flags.length;
                    for (let flagCode of mati.flags) {
                        let img = document.createElement('img');
                        mati.flaggenImages[mati.flags.indexOf(flagCode)] = img;
                        img.addEventListener("load", function() {
                            zuLadendeBilder--;
                            if (zuLadendeBilder === 0) {
                                //Flaggen malen
                                mati.ctx2d.clearRect(0, 0, 2048, 2048);
                                
                                for (let flaggeIndex = 0; flaggeIndex < mati.flaggenImages.length; flaggeIndex++) {
                                    let geladenesImg = mati.flaggenImages[flaggeIndex];
                                    let spalte = flaggeIndex % 6;
                                    let zeile = Math.floor(flaggeIndex / 6);
                                    
                                    let seitenverhaeltnis = geladenesImg.naturalWidth / geladenesImg.naturalHeight;
                                    let offsetX = 0;
                                    let offsetY = 0;
                                    if (geladenesImg.naturalWidth > geladenesImg.naturalHeight * 2) {
                                        offsetY = (geladenesImg.naturalWidth/2 - geladenesImg.naturalHeight) / geladenesImg.naturalWidth * 128;
                                    }
                                    if (geladenesImg.naturalWidth < geladenesImg.naturalHeight * 2) {
                                        offsetX = (geladenesImg.naturalHeight*2 - geladenesImg.naturalWidth) / geladenesImg.naturalHeight * 64;
                                    }
                                    
                                    mati.ctx2d.drawImage(geladenesImg, spalte * 320 + 32 + offsetX, zeile * 192 + 32 + offsetY, 256 - 2 * offsetX, 128 - 2 * offsetY);                        
                                }
                            
                                //Flaggen zur Grafikkarte schaffen
                                mati.gl.activeTexture(mati.gl.TEXTURE1);
                                mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.RGBA, mati.gl.RGBA, mati.gl.UNSIGNED_BYTE, mati.ctx2d.canvas);
                                mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                                mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
                            }
                        });
                        img.src = Tiltspot.get.assetUrl(`flags/${flagCode}.svg`);
                    }
                }
            };
            
            mati.renderTexture3 = function() {
                mati.ctx2d.clearRect(0, 0, 2048, 2048);
                
                mati.themeAnzahlTexturspalten = 1;
                while (mati.themeAnzahlTexturspalten * mati.themeAnzahlTexturspalten * 2 < mati.verfuegbareThemes.length) {
                    mati.themeAnzahlTexturspalten * 2;
                }
            
                let breiteProTheme = 2048 / mati.themeAnzahlTexturspalten;
                let hoeheProTheme = breiteProTheme / 2;
                let emGerundet = breiteProTheme / 4
                
                const font = 'Arial';
                const fontSize = emGerundet;
                const lineHeight = emGerundet * 1.3;
                
                mati.ctx2d.fillStyle = "white";
                mati.ctx2d.textAlign = "center";
                mati.ctx2d.textBaseline = "middle";
                for (let themeIndex = 0; themeIndex < mati.verfuegbareThemes.length; themeIndex++) {
                    let theme = mati.verfuegbareThemes[themeIndex];
                    let spalte = themeIndex % mati.themeAnzahlTexturspalten;
                    let zeile = Math.floor(themeIndex / mati.themeAnzahlTexturspalten);
                    mati.canvas2dRenderText(
                            mati.ctx2d,
                            theme.name,
                            breiteProTheme * (spalte + .5), hoeheProTheme * (zeile + .5), //Mittelpunkt-Pos
                            breiteProTheme * .875, hoeheProTheme * .875, //Groesse (mit bisl Gap)
                            font,
                            fontSize,
                            lineHeight);
                }

                mati.gl.activeTexture(mati.gl.TEXTURE3);
                mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.RGBA, mati.gl.RGBA, mati.gl.UNSIGNED_BYTE, mati.ctx2d.canvas);
                mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
            };
            
            mati.initAvatar = function() {
                if (mati.tiltspotIstInitialisiert && mati.gl) {
                    let img = document.createElement('img');
                    img.addEventListener("load", function() {
                        mati.ctx2d.clearRect(0, 0, 2048, 2048);
                        
                        mati.ctx2d.drawImage(img, 0, 0, 2048, 2048);                        
                    
                        mati.gl.activeTexture(mati.gl.TEXTURE2);
                        mati.gl.texImage2D(mati.gl.TEXTURE_2D, 0, mati.gl.RGBA, mati.gl.RGBA, mati.gl.UNSIGNED_BYTE, mati.ctx2d.canvas);
                        mati.gl.generateMipmap(mati.gl.TEXTURE_2D);
                        mati.gl.texParameteri(mati.gl.TEXTURE_2D, mati.gl.TEXTURE_MIN_FILTER, mati.gl.LINEAR_MIPMAP_LINEAR);
                    });
                    img.src = Tiltspot.get.user().profilePicture;
                }
            };
            
            mati.pauseMenueAusblenden = function() {
                let bereitsLaufendeAnimation = mati.getLaufendeAnimationByMatiAttribute('pauseMenueIstAufgeklapptFloat');
                if (bereitsLaufendeAnimation !== null) {
                    if (bereitsLaufendeAnimation.endValue === 0.0) {
                        //Menue wird bereits geschlossen, nichts zu tun
                        return;
                    }
                    else {
                        mati.cancelLaufendeAnimation('pauseMenueIstAufgeklapptFloat');
                    }
                }
                if (mati.pauseMenueIstAufgeklapptFloat > 0.0) {
                    let highResTimeStamp = window.performance.now();
                    mati.laufendeAnimationen.push({
                        matiAttribute : 'pauseMenueIstAufgeklapptFloat',
                        startValue : mati.pauseMenueIstAufgeklapptFloat,
                        endValue : 0.0,
                        startTime : highResTimeStamp,
                        endTime : highResTimeStamp + 500 * mati.pauseMenueIstAufgeklapptFloat
                    });
                }
            };
            
            mati.togglePauseMenue = function() {
                let menueSollGeschlossenWerden = mati.pauseMenueIstAufgeklapptFloat === 1.0;
                let bereitsLaufendeAnimation = mati.getLaufendeAnimationByMatiAttribute('pauseMenueIstAufgeklapptFloat');
                if (bereitsLaufendeAnimation !== null) {
                    menueSollGeschlossenWerden = bereitsLaufendeAnimation.endValue === 1.0;
                    mati.cancelLaufendeAnimation('pauseMenueIstAufgeklapptFloat');
                }
                
                let highResTimeStamp = window.performance.now();
                
                if (menueSollGeschlossenWerden) {
                    mati.laufendeAnimationen.push({
                        matiAttribute : 'pauseMenueIstAufgeklapptFloat',
                        startValue : mati.pauseMenueIstAufgeklapptFloat,
                        endValue : 0.0,
                        startTime : highResTimeStamp,
                        endTime : highResTimeStamp + 500 * mati.pauseMenueIstAufgeklapptFloat
                    });
                }
                else {
                    mati.laufendeAnimationen.push({
                        matiAttribute : 'pauseMenueIstAufgeklapptFloat',
                        startValue : mati.pauseMenueIstAufgeklapptFloat,
                        endValue : 1.0,
                        startTime : highResTimeStamp,
                        endTime : highResTimeStamp + 500 * (1.0 - mati.pauseMenueIstAufgeklapptFloat)
                    });
                }
            };
                        
            //Diese Methode wird sehr unzuverlaessig aufgerufen, stattdessen alles in erstem Aufruf von Tiltspot.on.msg fertig initialisieren
			Tiltspot.on.ready = function() {
				Tiltspot.send.msg('clientReady');
			};

			Tiltspot.on.msg = function (msg, data) {
                //TODO Name und Farbe bei Bedarf updaten
                if (!mati.tiltspotIstInitialisiert) {
                    mati.tiltspotIstInitialisiert = true;
                    mati.initFlaggen();
                    mati.initAvatar();
                }
				
				
				if (mati.sprachen.length === 0) {
                    //TODO boolean flag, dass Sprachen gerade geladen werden
                    matiUtil.loadJson(Tiltspot.get.assetUrl("content-list.json"), function(contentList) {
                        //Musik-Button auch einfach hier initialisieren
                        for (let musikButton of document.getElementsByClassName('mati_hauptmusik_button')) {
                            musikButton.addEventListener('click', function() {
                                Tiltspot.send.msg('setSound', !mati.musikIstEingeschaltet);
                            });
                        }                            
                    
                        let zuLadendeSprachen = [];
                        for (let contentName of contentList) {
                            if (contentName.indexOf('_') === -1) {
                                zuLadendeSprachen.push(contentName);
                            }
                        }
                        let anzahlZuLadendeSprachen = zuLadendeSprachen.length;
                        for (let spracheCode of zuLadendeSprachen) {
                            matiUtil.loadJson(Tiltspot.get.assetUrl("content/" + spracheCode + ".json"), function(texte) {
                                mati.sprachen[zuLadendeSprachen.indexOf(spracheCode)] = {
                                    code : spracheCode,
                                    texte : texte
                                };
                                anzahlZuLadendeSprachen--;
                                if (spracheCode === mati.spracheCode) {
                                    mati.initNeueSprache();
                                }
                                if (anzahlZuLadendeSprachen === 0) {                        
                                    //TODO Lang-Chooser updaten
                                }
                            });
                        }
                    });
                }
			
            
                if (data.spracheCode !== mati.spracheCode) {
                    mati.spracheCode = data.spracheCode;
                    mati.initNeueSprache();
				}
				
				if (data.sound !== mati.musikIstEingeschaltet) {
					mati.musikIstEingeschaltet = data.sound;
				}
            
				if (mati.basisfarbeMal255 === null) {
                    mati.basisfarbeMal255 = data.farbe;
                    let hell50dunkel80 = matiFarbutil.gedimmteFarbe(matiFarbutil.aufgehellteFarbe(data.farbe, .5), .8);
                    let hell50 = matiFarbutil.aufgehellteFarbe(data.farbe, .5);
                    let dunkel50 = matiFarbutil.gedimmteFarbe(data.farbe, .5);
                    let dunkel30 = matiFarbutil.gedimmteFarbe(data.farbe, .3);
                    mati.farbe = {r : data.farbe.rot / 255, g : data.farbe.gruen / 255, b : data.farbe.blau / 255};
                    mati.farbeHell50dunkel80 = {r : hell50dunkel80.rot / 255, g : hell50dunkel80.gruen / 255, b : hell50dunkel80.blau / 255};
                    mati.farbeHell50 = {r : hell50.rot / 255, g : hell50.gruen / 255, b : hell50.blau / 255};
                    mati.farbeDunkel50 = {r : dunkel50.rot / 255, g : dunkel50.gruen / 255, b : dunkel50.blau / 255};
                    mati.farbeDunkel30 = {r : dunkel30.rot / 255, g : dunkel30.gruen / 255, b : dunkel30.blau / 255};
                    if (mati.gl && mati.spracheIstInitialisiert) {
                        mati.initNachdemGlUndFarbeUndSpracheInitialisiertWurden();
                    }
				}
				
                if (!mati.spielernameIstInitialisiert) {
                    document.getElementById('mati_spieler_text').value = data.username;
                    mati.spielernameIstInitialisiert = true;
                }
				
			
				switch (msg) { 
					case 'zeigeHauptmenue':
                        mati.zeigeObjektGruppe('hauptmenue');
						break;
					case 'zeigeWarten':
                        mati.zeigeObjektGruppe('bitteWarten');
						break;
					case 'zeigeAntwortmoeglichkeiten':
                        mati.textAntwortA = data.antwortMoeglichkeiten[0];
                        mati.textAntwortB = data.antwortMoeglichkeiten[1];
                        if (mati.gl && mati.spracheIstInitialisiert) {
                            mati.renderTexture0();
                        }
						mati.anzahlSpieler = data.anzahlSpieler;
                        mati.zeigeObjektGruppe('antwortAuswahl');
						break;
					case 'zeigeSpielAbschliessen':
                        mati.zeigeObjektGruppe('spielAbschliessen');
						break;
                    case 'zeigeThemeSelection':
                        mati.verfuegbareThemes = data.verfuegbareThemes;
                        let themeIndex;
                        for (themeIndex = 0; themeIndex < data.verfuegbareThemes.length; themeIndex++) {
                            if (data.verfuegbareThemes[themeIndex].codeMitPrefix === data.aktuellesTheme) {
                                break;
                            }
                        }
                        mati.altesTheme = mati.aktuellesTheme;
                        mati.aktuellesTheme = themeIndex;
                        if (mati.aktuelleRendergruppe !== null && mati.aktuelleRendergruppe === 'themeSelection') {
                            if (mati.altesTheme !== mati.aktuellesTheme
                                    && data.lastDeltaThemeInThemeSelection !== 0) {
                                mati.cancelLaufendeAnimation('themeIconsOffset');
                                mati.lastDeltaThemeInThemeSelection = data.lastDeltaThemeInThemeSelection;
                                mati.themeIconsOffset = 1;
                                let highResTimeStamp = window.performance.now();
                                mati.laufendeAnimationen.push({
                                    matiAttribute : 'themeIconsOffset',
                                    startValue : 1,
                                    endValue : 0,
                                    startTime : highResTimeStamp,
                                    endTime : highResTimeStamp + 500
                                });
                            }
                        }
                        else {
                            mati.lastDeltaThemeInThemeSelection = 0;
                            mati.themeIconsOffset = 0;
                            if (mati.gl) {
                                mati.renderTexture3();
                                mati.themeSelectionIstInitialisiert = true;
                            }
                            mati.zeigeObjektGruppe('themeSelection');
                        }
				}
			};


            
            window.addEventListener('load', function() {
                
                
                
                
                let uniqueId = 1;
                for (let gruppenKey in mati.renderObjektGruppen) {
                    let gruppe = mati.renderObjektGruppen[gruppenKey];
                    for (let elementObjekt of gruppe) {
                        elementObjekt.uniqueId = uniqueId++;
                    }
                }
            
            
            
                var canvas = document.getElementById("mati_canvas");
                mati.gl = canvas.getContext("webgl");
                mati.gl.enable(mati.gl.BLEND);
                mati.gl.blendFunc(mati.gl.ONE, mati.gl.ONE_MINUS_SRC_ALPHA);

                mati.gl.enable(mati.gl.CULL_FACE);
                mati.gl.cullFace(mati.gl.BACK);

                
                
                
                
                for (let programObjectKey in mati.glProgramObjects) {
                    let programObject = mati.glProgramObjects[programObjectKey];
                    
                    let vertexShader = matiWebglUtil.createVertexShader(mati.gl, programObject.vertexShader);
                    let fragmentShader = matiWebglUtil.createFragmentShader(mati.gl, programObject.fragmentShader);
                    programObject.program = matiWebglUtil.createProgram(mati.gl, vertexShader, fragmentShader);
                    programObject.vertexBuffer = mati.gl.createBuffer();
                    programObject.indexBuffer = mati.gl.createBuffer();
                    for (let uniformName of programObject.uniformNames) {
                        programObject[uniformName] = mati.gl.getUniformLocation(programObject.program, uniformName)
                    }
                }

                
                var canvas2d = document.getElementById("mati_canvas_2d");
                canvas2d.width = 2048;
                canvas2d.height = 2048;
                mati.ctx2d = canvas2d.getContext('2d');
                
                var texture0 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE0);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture0);
                mati.initNeueSprache();
                
                var texture1 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE1);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture1);
                mati.initFlaggen();
                
                var texture2 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE2);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture2);
                mati.initAvatar();
                
                var texture3 = mati.gl.createTexture();
                mati.gl.activeTexture(mati.gl.TEXTURE3);
                mati.gl.bindTexture(mati.gl.TEXTURE_2D, texture3);
                if (!mati.themeSelectionIstInitialisiert && mati.verfuegbareThemes.length > 0) {
                    mati.renderTexture3();
                    mati.themeSelectionIstInitialisiert = true;
                }
                
                if (mati.basisfarbeMal255 && mati.spracheIstInitialisiert) {
                    mati.initNachdemGlUndFarbeUndSpracheInitialisiertWurden();
                }
            });
        </script>
    </body>
</head>