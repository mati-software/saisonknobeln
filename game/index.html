<!DOCTYPE html>
<html lang="de">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Saisonknobeln</title>
		
		<style id="mati_keyframes_3d">
			@keyframes mati_animation_box_show {
				from {
					transform: perspective(400vh) translateZ(-50vh) rotateX(-90deg) translateZ(50vh);
				}
				to {
					transform: perspective(400vh) translateZ(-50vh) rotateX(0deg) translateZ(50vh);
				}
			}
			@keyframes mati_animation_box_hide {
				from {
					transform: perspective(400vh) translateZ(-50vh) rotateX(0deg) translateZ(50vh);
				}
				to {
					transform: perspective(400vh) translateZ(-50vh) rotateX(90deg) translateZ(50vh);
				}
			}
		</style>
		
        <link href="style.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
		<div id="mati_spiel_alles">
			<div id="mati_spiel_lobby" class="mati_box">
				<div id="mati_intro_overlay">
				</div>
				<div id="mati_titel_container" style="visibility: hidden">
					<!-- Sichtbarer Dokumentinhalt im body -->
                    <div id="mati_titel">
                        <svg preserveAspectRatio="xMidYMid meet" viewBox="0 0 800 160" xmlns="http://www.w3.org/2000/svg"
                          xmlns:xlink="http://www.w3.org/1999/xlink">

                            <defs>
                                <!-- width muss den gesamten Bereich abdecken vor dem downscaling -->
                                <filter id="mati_svg_shadow" x="0" y="0" width="1100" height="160" filterUnits="userSpaceOnUse">
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="2"/>
                                    <feMerge>
                                      <feMergeNode/>
                                      <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                                <linearGradient id="mati_svg_farbverlauf" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0" stop-color="#ffcc33" />
                                    <stop offset="1" stop-color="#ff7700" />
                                </linearGradient>
                            </defs>


                            <g transform="scale(.8,1) skewX(-20)" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <g id="mati_svg_saisonknobeln">
                                    <g stroke="black" stroke-width="20" filter="url(#mati_svg_shadow)">
                                        <path id="mati_schriftzug_saisonknobeln" d="M 82 130
                                           m 0 -70  c 15 10 50 10 70 -10 c 7 -7 7 -28 -21 -28       c -80 0 65 115 -25 115 c -40 0 -40 -30 -30 -40 c -10 10 -10 40 30 40
                                           c 80 0 57 -55 95 -55 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 50 15 50
                                           q 25 0 25 -50 q 0 50 15 50
                                           q 10 0 35 -50 l -3 7 c 30 13 30 43 0 43
                                           c 60 0 40 -50 75 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                           c 10 0 10 -10 20 -10 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                           q 20 0 45 -50 q 25 -50 10 -50 q -15 0 -15 100 q 0 -50 17 -50 q 10 0 10 13 q 0 9 -20 13 c 20 0 20 24 40 24
                                           c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                           c 30 0 10 -50 45 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                           c 20 0 60 -60 38 -60 c -20 0 -20 100 15 100 q 25 0 12 -50 q 20 20 40 20
                                           c 40 0 40 -20 25 -20 c -25 0 -25 50 0 50
                                           q 20 0 45 -50 q 25 -50 10 -50 c -20 0 -20 100 15 100
                                           c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25 q 10 0 20 -10" />
                                    </g>
                                    <g stroke="url(#mati_svg_farbverlauf)" stroke-width="8">
                                        <path d="M 82 130
                                           m 0 -70  c 15 10 50 10 70 -10 c 7 -7 7 -28 -21 -28       c -80 0 65 115 -25 115 c -40 0 -40 -30 -30 -40 c -10 10 -10 40 30 40
                                           c 80 0 57 -55 95 -55 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 50 15 50
                                           q 25 0 25 -50 q 0 50 15 50
                                           q 10 0 35 -50 l -3 7 c 30 13 30 43 0 43
                                           c 60 0 40 -50 75 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                           c 10 0 10 -10 20 -10 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                           q 20 0 45 -50 q 25 -50 10 -50 q -15 0 -15 100 q 0 -50 17 -50 q 10 0 10 13 q 0 9 -20 13 c 20 0 20 24 40 24
                                           c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                           c 30 0 10 -50 45 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                           c 20 0 60 -60 38 -60 c -20 0 -20 100 15 100 q 25 0 12 -50 q 20 20 40 20
                                           c 40 0 40 -20 25 -20 c -25 0 -25 50 0 50
                                           q 20 0 45 -50 q 25 -50 10 -50 c -20 0 -20 100 15 100
                                           c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25 q 10 0 20 -10" />
                                    </g>
                                </g>
                                <g id="mati_svg_saisonknobeln_ipunkt">
                                    <g stroke="black" stroke-width="20" filter="url(#mati_svg_shadow)">
                                        <path id="mati_schriftzug_ipunkt" d="M -43 -50 l 10 0 l -10 0 m 50 50 m 250 55 l 0 -2" />
                                    </g>
                                    <g stroke="#ffcc33" stroke-width="8">
                                        <path d="M -43 -50 l 10 0 l -10 0 m 50 50 m 250 55 l 0 -2" />
                                    </g>
                                </g>

                                <g id="mati_svg_saisonknobeln2" stroke="#ff0000" stroke-width="12">
                                    <path d="M 82 130
                                       m 0 -70  c 15 10 50 10 70 -10 c 7 -7 7 -28 -21 -28       c -80 0 65 115 -25 115 c -40 0 -40 -30 -30 -40 c -10 10 -10 40 30 40
                                       c 80 0 57 -55 95 -55 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 50 15 50
                                       q 25 0 25 -50 q 0 50 15 50
                                       q 10 0 35 -50 l -3 7 c 30 13 30 43 0 43
                                       c 60 0 40 -50 75 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                       c 10 0 10 -10 20 -10 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                       q 20 0 45 -50 q 25 -50 10 -50 q -15 0 -15 100 q 0 -50 17 -50 q 10 0 10 13 q 0 9 -20 13 c 20 0 20 24 40 24
                                       c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25
                                       c 30 0 10 -50 45 -50 q 10 0 15 10 q -5 -10 -15 -10 c -30 0 -30 50 -5 50 q 20 0 20 -35 l 0 -15 q 0 10 15 10
                                       c 20 0 60 -60 38 -60 c -20 0 -20 100 15 100 q 25 0 12 -50 q 20 20 40 20
                                       c 40 0 40 -20 25 -20 c -25 0 -25 50 0 50
                                       q 20 0 45 -50 q 25 -50 10 -50 c -20 0 -20 100 15 100
                                       c 15 0 15 -50 30 -50 q 10 0 10 25 l 0 25 q 0 -50 17 -50 q 10 0 10 25 q 0 25 10 25 q 10 0 20 -10" />
                                </g>
                                <g id="mati_svg_saisonknobeln_ipunkt2" stroke="#ff0000" stroke-width="12">
                                    <path d="M -43 -50 l 10 0 l -10 0 m 50 50 m 250 55 l 0 -2" />
                                </g>
                            </g>
                        </svg>
                    </div>
				</div>
				<div id="mati_spiel_lobby_credits"></div>
				<div id="mati_spiel_lobby_content">
					<div id="mati_spiel_spielerliste">
						<div id="mati_spiel_spielerliste_caption">
						</div>
						<div id="mati_spiel_spielerliste_content">
						</div>
					</div>
                    
                    <div id="mati_sprachauswahl">
                        <svg id="mati_sprachauswahl_button_links" viewbox="0 0 50 100">
                            <path d="M5,50 l40,-40 l0,80 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M5,50 l40,-40 l0,80 z" fill="white" />
                        </svg>
                        <div id="mati_sprachauswahl_flaggen_container">
                        </div>
                        <svg id="mati_sprachauswahl_button_rechts" viewbox="0 0 50 100">
                            <path d="M45,50 l-40,-40 l0,80 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M45,50 l-40,-40 l0,80 z" fill="white" />
                        </svg>
                    </div>
                    
                    <svg id="mati_enter_toolbox_button" viewbox="0 0 120 120">
                        <path d="M99,7 A24,24 0 1,0 113,21 L97,37 L85,35 L83,23 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15,105 L75,45" stroke="black" stroke-width="28" stroke-linecap="round" />
                        <path d="M99,7 A24,24 0 1,0 113,21 L97,37 L85,35 L83,23 z" fill="white" />
                        <path d="M15,105 L75,45" stroke="white" stroke-width="20" stroke-linecap="round" />
                        
                        <path d="M25,15 L115,105 L105,115 L15,25 L5,5 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M25,15 L115,105 L105,115 L15,25 L5,5 z" fill="white" />
                        <path d="M25,15 L15,25" stroke="black" stroke-width="4" stroke-linecap="round" />
                        <path d="M9,7 L7,9" stroke="black" stroke-width="4" stroke-linecap="round" />
                    </svg>
                    
                    <svg id="mati_start_game_button" viewbox="0 0 120 120">
                        <path d="M115,60 L5,115 L5,5 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M115,60 L5,115 L5,5 z" fill="white" />
                    </svg>
				</div>
				<audio loop id="mati_hauptmusik">
					<source src="hauptmusik.ogg" type="audio/ogg"-->
					<source src="hauptmusik.mp3" type="audio/mpeg">
				</audio> 
				<audio id="mati_sectionintro_musik">
					<source src="sectionintro.ogg" type="audio/ogg">
					<source src="sectionintro.mp3" type="audio/mpeg">
				</audio> 
				<audio id="mati_erfolgsjingle_musik">
					<source src="erfolgsjingle.ogg" type="audio/ogg">
					<source src="erfolgsjingle.mp3" type="audio/mpeg">
				</audio> 
				
				<svg id="mati_hauptmusik_button" viewbox="0 0 200 120">
					<path d="M5 105 q0 -15 25 -15 q15 0 15 10 q0 15 -25 15 q-15 0 -15 -10 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
					<path d="M75 95 q0 -15 25 -15 q15 0 15 10 q0 15 -25 15 q-15 0 -15 -10 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
					<path d="M45 100 l0 -85 l-5 0 l0 85 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
					<path d="M115 90 l0 -85 l-5 5 l0 80 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
					<path d="M40 15 l75 -10 l0 20 l-75 10 z" stroke="black" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
					
					<path d="M5 105 q0 -15 25 -15 q15 0 15 10 q0 15 -25 15 q-15 0 -15 -10 z" fill="white" />
					<path d="M75 95 q0 -15 25 -15 q15 0 15 10 q0 15 -25 15 q-15 0 -15 -10 z" fill="white" />
					<path d="M45 100 l0 -85 l-5 0 l0 85 z" fill="white" />
					<path d="M115 90 l0 -85 l-5 5 l0 80 z" fill="white" />
					<path d="M40 15 l75 -10 l0 20 l-75 10 z" fill="white" />
					
					<path d="M115 60 m60 -45 a75 75 0 0 1 0 90" stroke="black" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					<path d="M115 60 m40 -30 a50 50 0 0 1 0 60" stroke="black" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					<path d="M115 60 m20 -15 a25 25 0 0 1 0 30" stroke="black" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					
					<path d="M115 60 m60 -45 a75 75 0 0 1 0 90" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					<path d="M115 60 m40 -30 a50 50 0 0 1 0 60" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					<path d="M115 60 m20 -15 a25 25 0 0 1 0 30" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					
					<g class="mati_hauptmusik_button_x">
						<path d="M10 10 L190 110" stroke="black" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none" />
						<path d="M10 110 L190 10" stroke="black" stroke-width="16" stroke-linecap="round" stroke-linejoin="round" fill="none" />
						
						<path d="M10 10 L190 110" stroke="#ff1111" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
						<path d="M10 110 L190 10" stroke="#ff1111" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
					</g>
				</svg>
			</div>
			<div id="mati_section_intro" class="mati_box">
				<div id="mati_section_intro_balken1"></div>
				<div id="mati_section_intro_balken2"></div>
				<svg viewbox="0 0 1000 150">
					<defs>
						<filter id="mati_section_text_shadow" filterUnits="userSpaceOnUse" x="0" y="0" width="100%" height="100%">
							<feGaussianBlur result="blurOut" in="SourceAlpha" stdDeviation="5" />
							<feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
						</filter>				
						<linearGradient id="mati_section_text_verlauf" x1="0" y1="0" x2="0" y2="1">
							<stop offset="0" stop-color="#eeeeee" />
							<stop offset="1" stop-color="#bbbbbb" />
						</linearGradient>
					</defs>
					<text font-size="100" filter="url(#mati_section_text_shadow)" stroke="url(#mati_section_text_verlauf)" fill="none" stroke-width="3" font-weight="800" text-anchor="middle" id="mati_section_intro_name" x="50%" y="110">
						Saisonknobeln
					</text>
				</svg>
			</div>
			<div id="mati_frage" class="mati_box">
				<div id="mati_frage_grid">
					<div id="mati_frage_erlaeuterung"></div>
					<div id="mati_frage_text_und_bild">
						<div id="mati_frage_text_container">
							<div id="mati_frage_text"></div>
						</div>
						<div id="mati_frage_bild"></div>
					</div>
					<div id="mati_frage_spieler_container">
						<div id="mati_frage_spieler">
						</div>
					</div>
				</div>
			</div>
			<div id="mati_frage_ergebnis" class="mati_box">
				<div id="mati_frage_ergebnis_schaetzungen_container_container">
					<div id="mati_frage_ergebnis_schaetzungen_container">
						<div id="mati_frage_ergebnis_tatsaechlich_container">
							<div id="mati_frage_ergebnis_tatsaechlich">
								<div id="mati_frage_ergebnis_strich">
								</div>
								<div id="mati_frage_ergebnis_tatsaechlich_box">
									<div id="mati_frage_ergebnis_tatsaechlich_a"></div>
									<div id="mati_frage_ergebnis_tatsaechlich_doppelpunkt">:</div>
									<div id="mati_frage_ergebnis_tatsaechlich_b"></div>
								</div>
							</div>
						</div>
				
						<div id="mati_frage_ergebnis_schaetzungen">
						</div>
					</div>
				</div>
			</div>
			<div id="mati_punktestand" class="mati_box">
				<div id="mati_punktestand_spielerliste_container_container">
					<div id="mati_punktestand_ueberschrift">
					</div>
					<div id="mati_punktestand_spielerliste_container">
						<div id="mati_punktestand_spielerliste">
						</div>
					</div>
				</div>
			</div>
            <div id="mati_theme_selection" class="mati_box">
                <div id="mati_theme_selection_grid">
					<div id="mati_theme_selection_erlaeuterung"></div>
					<div id="mati_theme_selection_content">
                        <div id="mati_theme_selection_items">
                        </div>
                        <div id="mati_theme_selection_ui">
                            <div class="mati_null_breite"></div>
                            <div id="mati_theme_selection_button_prev">
                                <svg viewbox="0 0 50 100">
                                    <path d="M5,50 l40,-40 l0,80 z" fill="black" />
                                </svg>
                            </div>
                            <div id="mati_theme_selection_button_spacer"></div>
                            <div id="mati_theme_selection_button_next">
                                <svg viewbox="0 0 50 100">
                                    <path d="M45,50 l-40,-40 l0,80 z" fill="black" />
                                </svg>
                            </div>
                            <div class="mati_null_breite"></div>
                        </div>
					</div>
				</div>
            </div>
            <div id="mati_toolbox" class="mati_box">
				<div id="mati_toolbox_container_container">
                    <div class="mati_toolbox_button" id="mati_toolbox_button_theme_erstellen"></div>
                    <label for="mati_toolbox_theme_file_input" class="mati_toolbox_button" id="mati_toolbox_button_theme_importieren"></label>
                    <input id="mati_toolbox_theme_file_input" type="file"  accept=".zip" multiple="multiple" />
                    <div class="mati_toolbox_button" id="mati_toolbox_button_sprache_erstellen"></div>
                    <label for="mati_toolbox_language_file_input" class="mati_toolbox_button" id="mati_toolbox_button_sprache_importieren"></label>
                    <input id="mati_toolbox_language_file_input" type="file" accept=".json" multiple="multiple" />
                    
                    <div id="mati_toolbox_verlassen_button">
                        <svg viewbox="0 0 45 35">
                            <path d="M5,25 L30,25 A10,10 0 1,0 30,5 L25,5 M15,20 L5,25 L15,30" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
				</div>
                <svg id="mati_icon_success" preserveAspectRatio="xMidYMid meet" viewBox="0 0 70 70" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <circle cx="35" cy="35" r="30" fill="#00CC22" />
                    <path d="M18,43 L27,52 L51,24" fill="none" stroke="white" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
			</div>
            <div id="mati_toolbox_sprache_erstellen" class="mati_box">
				<div id="mati_toolbox_sprache_erstellen_container_container">
				</div>
			</div>
            <div id="mati_toolbox_theme_erstellen" class="mati_box">
				<div id="mati_toolbox_theme_erstellen_container_container">
				</div>
			</div>
		</div>

        <script src="lib/jszip.min.js" rel="script" type="application/javascript"></script>
		<script src="lib/velocity.min.js" rel="script" type="application/javascript"></script>
		<script src="matiUtil.js" rel="script" type="application/javascript"></script>
		<script src="matiFarbutil.js" rel="script" type="application/javascript"></script>
		<script src="matiAnimationUtil.js" rel="script" type="application/javascript"></script>
		<script src="https://tiltspot.tv/api/game/game-1.0.0.js" rel="script" type="application/javascript"></script>
		<script src="saisonknobeln.js" rel="script" type="application/javascript"></script>
		<script>
			//TODO booleanparameter aus zeigeContainer-Methode ist ueberfluessig
			//TODO das Hintergrundbild hat derzeit eine seltsame Pfadangabe... versuch CSS auszulagern und dann den Pfad weg zu lassen, oder nutze Assets-Ordner
		
			Tiltspot.on.ready = function() {
                matiUtil.pushBefehl(function() {
                    if (mati.sprachen.length === 0) {
                        matiUtil.loadJson(Tiltspot.get.assetUrl("content-list.json"), function(contentList) {
                            let zuLadendeSprachen = [];
                            let zuLadendeThemes = [];
                            for (let contentName of contentList) {
                                if (contentName.indexOf('_') === -1) {
                                    zuLadendeSprachen.push(contentName);
                                }
                                else {
                                    zuLadendeThemes.push(contentName);
                                }
                            }
                            let anzahlZuLadendeSprachen = zuLadendeSprachen.length;
                            for (let spracheCode of zuLadendeSprachen) {
                                matiUtil.loadJson(Tiltspot.get.assetUrl("content/" + spracheCode + ".json"), function(texte) {
                                    //An passender Stelle in Array einfuegen (Reihenfolge soll genau so sein wie in der content-list angegeben)
                                    mati.sprachen[zuLadendeSprachen.indexOf(spracheCode)] = {
                                        code : spracheCode,
                                        texte : texte
                                    };
                                    anzahlZuLadendeSprachen--;
                                    if (anzahlZuLadendeSprachen === 0) {
                                        //Themes laden
                                        let anzahlZuLadendeThemes = zuLadendeThemes.length;
                                        for (let themeCodeMitPrefix of zuLadendeThemes) {
                                            matiUtil.loadJson(Tiltspot.get.assetUrl("content/" + themeCodeMitPrefix + "/theme.json"), function(themeContent) {
                                                mati.themes[zuLadendeThemes.indexOf(themeCodeMitPrefix)] = {
                                                    codeMitPrefix : themeCodeMitPrefix,
                                                    content : themeContent,
                                                    themeImage : null,
                                                    sectionImages : null,
                                                    shuffledQuestionOrderForSections : []
                                                };
                                                anzahlZuLadendeThemes--;
                                                if (anzahlZuLadendeThemes === 0) {
                                                    mati.renderSprachauswahl();
                                                    
                                                    document.getElementById('mati_sprachauswahl_button_links').addEventListener('click', function() {
                                                        let indexAktuelleSprache = mati.getIndexAktuelleSprache();
                                                        let neueSprache = mati.sprachen[(mati.sprachen.length + indexAktuelleSprache - 1) % mati.sprachen.length];
                                                        mati.setSpracheCode(neueSprache.code);
                                                    });
                                                    document.getElementById('mati_sprachauswahl_button_rechts').addEventListener('click', function() {
                                                        let indexAktuelleSprache = mati.getIndexAktuelleSprache();
                                                        let neueSprache = mati.sprachen[(indexAktuelleSprache + 1) % mati.sprachen.length];
                                                        mati.setSpracheCode(neueSprache.code);
                                                    });
                                                    document.getElementById('mati_sprachauswahl_flaggen_container').addEventListener('click', function() {
                                                        let indexAktuelleSprache = mati.getIndexAktuelleSprache();
                                                        let neueSprache = mati.sprachen[(indexAktuelleSprache + 1) % mati.sprachen.length];
                                                        mati.setSpracheCode(neueSprache.code);
                                                    });
                                                    
                                                    matiUtil.gotoNaechsterBefehl();
                                                }
                                            });
                                        }
                                    }
                                });
                            }
                        });
                    }
                    else {
                        matiUtil.gotoNaechsterBefehl();
                    }
                });
                
                mati.setSpracheCode('en');
                mati.spielerChanged();
                
				matiUtil.pushBefehl(function() {
					mati.broadcast('zeigeHauptmenue');
                    //TODO seltsam, dass das ganz oben statt unten steht
					mati.zeigeContainer(document.getElementById('mati_spiel_lobby'), matiUtil.gotoNaechsterBefehl);
                    
                    document.getElementById('mati_hauptmusik').play();

                    var mati_svg_saisonknobeln = document.getElementById('mati_svg_saisonknobeln');
                    var mati_svg_saisonknobeln2 = document.getElementById('mati_svg_saisonknobeln2');
                    var mati_svg_saisonknobeln_ipunkt = document.getElementById('mati_svg_saisonknobeln_ipunkt');
                    var mati_svg_saisonknobeln_ipunkt2 = document.getElementById('mati_svg_saisonknobeln_ipunkt2');
                    var mati_schriftzug_saisonknobeln_length = document.getElementById('mati_schriftzug_saisonknobeln').getTotalLength();
                    var mati_schriftzug_ipunkt_length = document.getElementById('mati_schriftzug_ipunkt').getTotalLength();
                    var mati_schriftzug_stiftlaenge = 10;
                    let mati_titel = document.getElementById('mati_titel');

                    matiAnimationUtil.animate('matiIntroQueue',
                        [
                            'parallel',
                            [
                                'successive',
                                {
                                    element : document.getElementById('mati_intro_overlay'),
                                    attribute : 'background-color',
                                    start : 'rgb(0,0,0)',
                                    end : 'rgb(255, 255, 255)',
                                    easing: 'linear',
                                    duration: 3000
                                },
                                {
                                    element : document.getElementById('mati_intro_overlay'),
                                    attribute : 'background-color',
                                    start : 'rgba(255, 255, 255, 1)',
                                    end : 'rgba(255, 255, 255, 0)',
                                    easing: 'linear',
                                    duration: 3000
                                },
                                () => {
                                    let overlay = document.getElementById('mati_intro_overlay');
                                    overlay.parentNode.removeChild(overlay);
                                }
                            ],
                            [
                                'successive',
                                () => {
                                    mati_svg_saisonknobeln.setAttribute('stroke-dasharray', mati_schriftzug_saisonknobeln_length + ' ' + mati_schriftzug_saisonknobeln_length);
                                    mati_svg_saisonknobeln2.setAttribute('stroke-dasharray', mati_schriftzug_stiftlaenge + ' ' + mati_schriftzug_saisonknobeln_length);
                                    mati_svg_saisonknobeln_ipunkt.setAttribute('stroke-dasharray', mati_schriftzug_ipunkt_length + ' ' + mati_schriftzug_ipunkt_length);
                                    mati_svg_saisonknobeln_ipunkt2.setAttribute('stroke-dasharray', mati_schriftzug_stiftlaenge + ' ' + mati_schriftzug_ipunkt_length);

                                    mati_svg_saisonknobeln_ipunkt.style['visibility'] = 'hidden';
                                    mati_svg_saisonknobeln_ipunkt2.style['visibility'] = 'hidden';

                                    document.getElementById('mati_titel_container').style['visibility'] = 'visible';            
                                },
                                [
                                    'parallel',
                                    {
                                        element : mati_svg_saisonknobeln,
                                        start : mati_schriftzug_saisonknobeln_length,
                                        end : 0,
                                        attribute : 'stroke-dashoffset',
                                        duration : 5900,
                                        easing : 'linear'
                                    },
                                    {
                                        element : mati_svg_saisonknobeln2,
                                        start : mati_schriftzug_stiftlaenge,
                                        end : -mati_schriftzug_saisonknobeln_length,
                                        attribute : 'stroke-dashoffset',
                                        duration : 5900,
                                        easing : 'linear'
                                    }
                                ],
                                () => {
                                    mati_svg_saisonknobeln.removeAttribute('stroke-dashoffset');
                                    mati_svg_saisonknobeln.removeAttribute('stroke-dasharray');
                                    mati_svg_saisonknobeln_ipunkt.style['visibility'] = 'visible';
                                    mati_svg_saisonknobeln2.parentNode.removeChild(mati_svg_saisonknobeln2);
                                    mati_svg_saisonknobeln_ipunkt2.style['visibility'] = 'visible';
                                },
                                [
                                    'parallel',
                                    {
                                        element : mati_svg_saisonknobeln_ipunkt,
                                        attribute : 'stroke-dashoffset',
                                        start : mati_schriftzug_ipunkt_length,
                                        end : 0,
                                        duration : 100,
                                        easing : 'linear'
                                    },
                                    {
                                        element : mati_svg_saisonknobeln_ipunkt2,
                                        attribute : 'stroke-dashoffset',
                                        start : mati_schriftzug_stiftlaenge,
                                        end : -mati_schriftzug_ipunkt_length,
                                        duration : 100,
                                        easing : 'linear'
                                    }
                                ],
                                () => {
                                    mati_svg_saisonknobeln_ipunkt.removeAttribute('stroke-dashoffset');
                                    mati_svg_saisonknobeln_ipunkt.removeAttribute('stroke-dasharray');
                                    mati_svg_saisonknobeln_ipunkt2.parentNode.removeChild(mati_svg_saisonknobeln_ipunkt2);
                                },
                                {
                                    element : mati_titel,
                                    list : [
                                        {
                                            attribute : 'top',
                                            end : 0
                                        },
                                        {
                                            attribute : 'height',
                                            end : document.getElementById('mati_titel_container').offsetHeight + 'px'
                                        }
                                    ],
                                    duration : 2000,
                                    easing: 'linear'
                                },
                                () => {
                                    mati_titel.style['height'] = '100%';
                                    document.getElementById('mati_spiel_lobby_credits').style['display'] = 'block';
                                    document.getElementById('mati_spiel_lobby_content').style['display'] = 'flex';
                                    mati.spielerChanged();
                                }
                            ]
                        ]
                    );                    
                    
                    
                    
					document.getElementById("mati_hauptmusik_button").addEventListener("click",function() {
						if (matiUtil.musikIstEingeschaltet) {
							matiUtil.musikAusschalten(document.getElementById("mati_hauptmusik"));
							for (let musikXIcon of document.getElementsByClassName("mati_hauptmusik_button_x")) {
								musikXIcon.style['visibility'] = 'visible';
							}
						}
						else {
							matiUtil.musikEinschalten(document.getElementById("mati_hauptmusik"));
							for (let musikXIcon of document.getElementsByClassName("mati_hauptmusik_button_x")) {
								musikXIcon.style['visibility'] = 'hidden';
							}
						}
						mati.broadcast();
					});
                    
                    document.getElementById('mati_enter_toolbox_button').addEventListener("click",function() {
                        mati.pushOpenToolbox();
                    });
                    
                    document.getElementById('mati_start_game_button').addEventListener("click",function() {
                        mati.neuesSpiel();
                    });
				});
			};
			Tiltspot.on.connect = function(controllerId) {
				mati.spielerChanged();
			}; 
			Tiltspot.on.disconnect = function(controllerId) {
				mati.spielerChanged();
			};
			Tiltspot.on.reconnect = function(controllerId) {
				mati.spielerChanged();
				mati.sendMsg(controllerId);
			};
			Tiltspot.on.msg = function (controllerId, msg, data) {
				switch (msg) { 
					case 'setSpracheCode':
						mati.setSpracheCode(data);
						break;
					case 'neuesSpiel':
						mati.neuesSpiel();
						break;
					case 'clientReady':
						//Client hat ggf. den letzten Befehl nicht mitbekommen
						mati.sendMsg(controllerId);
						break;
                    case 'getSprachen':
                        mati.sendMsg(controllerId, undefined, true);
                        break;
					case 'antwortAbgeben':
						let spieler = mati.getSpielerImLaufendenSpielById(controllerId);
						spieler.antwortAufAktuelleFrage = data.antwort;
						spieler.schaetzungAFuerAktuelleFrage = data.schaetzungAntwortA;
						spieler.schaetzungBFuerAktuelleFrage = data.schaetzungAntwortB;
						let spielerElement = document.getElementById('mati_frage_spieler').getElementsByClassName('mati_spieler_id_' + controllerId)[0];
						spielerElement.classList.remove('mati_wackelnd');
						spielerElement.classList.add('mati_spieler_fertig');
						mati.gotoNaechsterBefehlFallsAlleAntwortenAbgegebenWurden();
						//Nochmal Wartebefehl senden, damit bei Smartphone-Browser-Reload keine erneute Stimmabgabe moeglich ist
						mati.sendMsg(controllerId, 'zeigeWarten');
						break;
					case 'spielAbschliessen':
						matiUtil.gotoNaechsterBefehl();
						break;
					case 'setSound':
						if (data) {
							matiUtil.musikEinschalten(document.getElementById("mati_hauptmusik"));
							for (let musikXIcon of document.getElementsByClassName("mati_hauptmusik_button_x")) {
								musikXIcon.style['visibility'] = 'hidden';
							}
						}
						else {
							matiUtil.musikAusschalten(document.getElementById("mati_hauptmusik"));
							for (let musikXIcon of document.getElementsByClassName("mati_hauptmusik_button_x")) {
								musikXIcon.style['visibility'] = 'visible';
							}
						}
						mati.broadcast();
						break;
                    case 'spielAbbrechen':
                        if (mati.aktuellerStatus === 'themeauswahl' || mati.aktuellerStatus === 'spiel' || mati.aktuellerStatus === 'toolbox') {
                            if (mati.queueEnthaeltLaufendesSpiel) {
                                matiUtil.befehlsqueueLeeren();
                                mati.queueEnthaeltLaufendesSpiel = false;
                            }
                            mati.aktuellerStatus = 'hauptmenue';
                            matiUtil.pushBefehl(function() {
                                mati.broadcast('zeigeHauptmenue');
                                mati.zeigeContainer(document.getElementById('mati_spiel_lobby'), matiUtil.gotoNaechsterBefehl);
                            });
                        }
                        break;
                    case 'prevTheme':
                        mati.wechseleTheme(-1);
                        break;
                    case 'nextTheme':
                        mati.wechseleTheme(1);
                        break;
                    case 'themeSelectionOk':
                        mati.pushThemeStarten();
                        break;
                    case 'setUsername':
                        mati.changeUsername(controllerId, data);
                        break;
				}
			};				
		
			var onAenderungDerFenstergroesse = function() {
				var allesFontSize = Math.min(window.innerWidth, window.innerHeight) / 23;
				document.getElementById('mati_spiel_alles').style["font-size"] = allesFontSize + "px";
				
				mati.setFrageGroesseUndPosition();
				
				let oldMatiFrageDisplay = document.getElementById('mati_frage').style['display'];
				document.getElementById('mati_frage').style['display'] = 'block';
				mati.schrittweiseResizeBisEsPasst(document.getElementById('mati_frage_spieler_container'), document.getElementById('mati_frage_spieler'));
				document.getElementById('mati_frage').style['display'] = oldMatiFrageDisplay;
				
				//Workaround fuer verbuggter Microsoft-Edge-Browser, der mit vh in Animationen nicht klar kommt.
				let hoehe = document.getElementById('mati_spiel_alles').offsetHeight;
				document.getElementById('mati_keyframes_3d').innerHTML = `
					@keyframes mati_animation_box_show {
						from {
							transform: perspective(${hoehe*4}px) translateZ(${-hoehe/2}px) rotateX(-90deg) translateZ(${hoehe/2}px);
						}
						to {
							transform: perspective(${hoehe*4}px) translateZ(${-hoehe/2}px) rotateX(0deg) translateZ(${hoehe/2}px);
						}
					}
					@keyframes mati_animation_box_hide {
						from {
							transform: perspective(${hoehe*4}px) translateZ(${-hoehe/2}px) rotateX(0deg) translateZ(${hoehe/2}px);
						}
						to {
							transform: perspective(${hoehe*4}px) translateZ(${-hoehe/2}px) rotateX(90deg) translateZ(${hoehe/2}px);
						}
					}
				`;
			};
			onAenderungDerFenstergroesse();
			window.addEventListener( 'resize', onAenderungDerFenstergroesse, false );
			
			document.getElementById('mati_theme_selection_button_prev').addEventListener('click', function() {
                if (!mati.themeSelectionDeaktiviert) {
                    mati.wechseleTheme(-1);
                }
            });
			document.getElementById('mati_theme_selection_button_next').addEventListener('click', function() {
                if (!mati.themeSelectionDeaktiviert) {
                    mati.wechseleTheme(1);
                }
            });
			document.getElementById('mati_theme_selection_button_spacer').addEventListener('click', function() {
                mati.pushThemeStarten();
            });
            
            document.getElementById('mati_toolbox_verlassen_button').addEventListener('click', function() {
                matiUtil.pushBefehl(function() {
                    mati.aktuellerStatus = 'hauptmenue';
                    mati.broadcast('zeigeHauptmenue');
                    mati.zeigeContainer(document.getElementById('mati_spiel_lobby'), matiUtil.gotoNaechsterBefehl);
                });
            });
            document.getElementById('mati_toolbox_button_theme_erstellen').addEventListener('click', function() {
                matiUtil.pushBefehl(function() {
                    mati.aktuellerStatus = 'toolbox';
                    mati.broadcast('zeigeWarten');
                    mati.zeigeContainer(document.getElementById('mati_toolbox_theme_erstellen'), matiUtil.gotoNaechsterBefehl);
                });
                matiUtil.pushBefehl(function() {
                    let iframeContainer = document.getElementById('mati_toolbox_theme_erstellen_container_container');
                    if (iframeContainer.getElementsByTagName('iframe').length === 0) {
                        iframeContainer.innerHTML = `<iframe src="${Tiltspot.get.assetUrl('create_theme.html')}"></iframe>`;
                    }
                    else {
                        //iframeContainer.getElementsByTagName('iframe')[0].contentWindow.scrollTo(0, 0);
                    }
                    matiUtil.gotoNaechsterBefehl();
                });
            });
            document.getElementById('mati_toolbox_button_sprache_erstellen').addEventListener('click', function() {
                matiUtil.pushBefehl(function() {
                    mati.aktuellerStatus = 'toolbox';
                    mati.broadcast('zeigeWarten');
                    mati.zeigeContainer(document.getElementById('mati_toolbox_sprache_erstellen'), matiUtil.gotoNaechsterBefehl);
                });
                matiUtil.pushBefehl(function() {
                    let iframeContainer = document.getElementById('mati_toolbox_sprache_erstellen_container_container');
                    if (iframeContainer.getElementsByTagName('iframe').length === 0) {
                        iframeContainer.innerHTML = `<iframe src="${Tiltspot.get.assetUrl('create_language.html')}"></iframe>`;
                    }
                    else {
                        //iframeContainer.getElementsByTagName('iframe')[0].contentWindow.scrollTo(0, 0);
                    }
                    matiUtil.gotoNaechsterBefehl();
                });
            });
            document.getElementById('mati_toolbox_language_file_input').addEventListener('change', function() {
                for (let file of this.files) {
                    let reader = new FileReader();
                    reader.readAsText(file, 'utf-8');
                    //TODO Fehlermeldung und Erfolgsmeldung
                    reader.onload = function() {
                        let spracheCodeArray = file.name.match(/^[a-z]+/);
                        if (Array.isArray(spracheCodeArray) && spracheCodeArray.length > 0) {
                            let spracheCode = spracheCodeArray[0];
                            if (typeof spracheCode === 'string' && spracheCode.length > 0) {
                                let sprache = JSON.parse(reader.result);
                                mati.pushAddNewLaguage(spracheCode, sprache);
                                mati.pushShowSuccessIcon();
                            }
                        }
                    };
                }
            });
            document.getElementById('mati_toolbox_theme_file_input').addEventListener('change', function() {
                for (let file of this.files) {
                    let zip = new JSZip();
                    zip.loadAsync(file).then(function(contents) {
                        let folderName;
                        for (let fileName of Object.keys(contents.files)) {
                            if (contents.files[fileName].dir) {
                                folderName = fileName;
                                break;
                            }
                        }
                        let fullThemeCode = folderName.substring(0, folderName.length - 1);
                        zip.file(folderName + 'theme.json').async('string').then(function(jsonContent) {
                            let parsedTheme = JSON.parse(jsonContent);

                            //TODO validieren
                            
                            let imageMap = {};
                            imageMap['theme.jpg'] = null;
                            for (let section of parsedTheme.sections) {
                                imageMap[section.img] = null;
                                for (let question of section.questions) {
                                    if (question.img) {
                                        imageMap[question.img] = null;
                                    }
                                }
                            }
                            let anzahlZuLadendeBilder = 0;
                            for (let imgName in imageMap) {
                                anzahlZuLadendeBilder++;
                            }
                            for (let imgName in imageMap) {
                                zip.file(folderName + imgName).async('blob').then(function(imgBlob) {
                                    imageMap[imgName] = imgBlob;
                                    anzahlZuLadendeBilder--;
                                    if (anzahlZuLadendeBilder === 0) {
                                        mati.pushAddNewTheme(fullThemeCode, parsedTheme, imageMap);
                                        mati.pushShowSuccessIcon();
                                    }
                                });
                            }
                        });
                    });
                }
            });
		</script>

	</body>
</html>